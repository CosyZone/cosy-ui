---
# ğŸ¥ Cosy UI å¥åº·æ£€æŸ¥å·¥ä½œæµ
#
# è¿™ä¸ªå·¥ä½œæµç¨‹ç”¨äºå®šæ—¶æ£€æŸ¥ Cosy UI ç»„ä»¶åº“çš„å¥åº·çŠ¶æ€ï¼š
# 1. éªŒè¯åŒ…åœ¨å„ä¸ªåŒ…ç®¡ç†å™¨ä¸­çš„å¯ç”¨æ€§ï¼ˆnpmã€yarnã€pnpmï¼‰
# 2. æ£€æŸ¥æ–‡æ¡£ç½‘ç«™çš„å¯è®¿é—®æ€§
# 3. ç¡®ä¿åŒ…çš„åŸºæœ¬åŠŸèƒ½æ­£å¸¸
#
# æ£€æŸ¥é¢‘ç‡ï¼š
# - æ¯å¤©åŒ—äº¬æ—¶é—´ 09:00 (UTC 01:00)
# - æ¯å¤©åŒ—äº¬æ—¶é—´ 21:00 (UTC 13:00)
# - ä¹Ÿå¯ä»¥æ‰‹åŠ¨è§¦å‘
#
# å¦‚æœæ£€æŸ¥å¤±è´¥ï¼Œä¼šåˆ›å»º GitHub Issue æ¥é€šçŸ¥ç»´æŠ¤è€…

name: ğŸ¥ Health Check

on:
  schedule:
    # æ¯å¤© 09:00 å’Œ 21:00 (åŒ—äº¬æ—¶é—´)
    - cron: '0 1,13 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
  
  # åœ¨å‘å¸ƒåä¹Ÿè¿è¡Œä¸€æ¬¡æ£€æŸ¥
  workflow_run:
    workflows: ["ğŸ“¦ Release Cosy UI"]
    types:
      - completed

permissions:
  contents: read
  issues: write

jobs:
  health-check:
    name: ğŸ” Health Check
    runs-on: ubuntu-latest
    strategy:
      matrix:
        package-manager: [npm, yarn, pnpm]
        node-version: [18, 20, 22]
      fail-fast: false # ä¸è¦å› ä¸ºä¸€ä¸ªå¤±è´¥å°±åœæ­¢æ‰€æœ‰æ£€æŸ¥
      
    steps:
      - name: ğŸ“‹ Setup Info
        run: |
          echo "ğŸ” å¼€å§‹å¥åº·æ£€æŸ¥..."
          echo "ğŸ“¦ åŒ…ç®¡ç†å™¨: ${{ matrix.package-manager }}"
          echo "ğŸ“¦ Node.js ç‰ˆæœ¬: ${{ matrix.node-version }}"
          echo "ğŸŒ æ–‡æ¡£ç½‘ç«™: https://cofficlab.github.io/cosy-ui/en/courses/guide/"
          
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          
      - name: ğŸ“¦ Setup Package Managers
        run: |
          # å®‰è£… yarn å’Œ pnpm
          npm install -g yarn pnpm
          
          # æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯
          echo "ğŸ“‹ ç‰ˆæœ¬ä¿¡æ¯:"
          echo "Node.js: $(node --version)"
          echo "npm: $(npm --version)"
          echo "yarn: $(yarn --version)"
          echo "pnpm: $(pnpm --version)"
          
      - name: ğŸ—ï¸ Create Test Project
        run: |
          # åˆ›å»ºä¸´æ—¶æµ‹è¯•é¡¹ç›®
          mkdir -p /tmp/cosy-ui-test
          cd /tmp/cosy-ui-test
          
          # åˆå§‹åŒ–é¡¹ç›®
          if [[ "${{ matrix.package-manager }}" == "npm" ]]; then
            npm init -y
          elif [[ "${{ matrix.package-manager }}" == "yarn" ]]; then
            yarn init -y
          else
            pnpm init
          fi
          
      - name: ğŸ“¥ Install Package
        id: install
        run: |
          cd /tmp/cosy-ui-test
          
          echo "ğŸ”„ ä½¿ç”¨ ${{ matrix.package-manager }} å®‰è£… @coffic/cosy-ui..."
          
          # æ ¹æ®åŒ…ç®¡ç†å™¨å®‰è£…åŒ…
          if [[ "${{ matrix.package-manager }}" == "npm" ]]; then
            npm install @coffic/cosy-ui
            INSTALL_EXIT_CODE=$?
          elif [[ "${{ matrix.package-manager }}" == "yarn" ]]; then
            yarn add @coffic/cosy-ui
            INSTALL_EXIT_CODE=$?
          else
            pnpm add @coffic/cosy-ui
            INSTALL_EXIT_CODE=$?
          fi
          
          if [ $INSTALL_EXIT_CODE -eq 0 ]; then
            echo "âœ… åŒ…å®‰è£…æˆåŠŸ"
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ åŒ…å®‰è£…å¤±è´¥"
            echo "success=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
      - name: ğŸ” Verify Package
        if: steps.install.outputs.success == 'true'
        run: |
          cd /tmp/cosy-ui-test
          
          echo "ğŸ” éªŒè¯åŒ…çš„å®Œæ•´æ€§..."
          
          # æ£€æŸ¥åŒ…æ˜¯å¦æ­£ç¡®å®‰è£…
          if [[ "${{ matrix.package-manager }}" == "npm" ]]; then
            npm list @coffic/cosy-ui
          elif [[ "${{ matrix.package-manager }}" == "yarn" ]]; then
            yarn list @coffic/cosy-ui
          else
            pnpm list @coffic/cosy-ui
          fi
          
          # æ£€æŸ¥å…³é”®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ -f "node_modules/@coffic/cosy-ui/package.json" ]; then
            echo "âœ… package.json å­˜åœ¨"
            cat node_modules/@coffic/cosy-ui/package.json | jq '.version'
          else
            echo "âŒ package.json ä¸å­˜åœ¨"
            exit 1
          fi
          
          # æ£€æŸ¥ä¸»è¦å¯¼å‡ºæ–‡ä»¶
          if [ -f "node_modules/@coffic/cosy-ui/dist/index-astro.ts" ]; then
            echo "âœ… ä¸»è¦å¯¼å‡ºæ–‡ä»¶å­˜åœ¨"
          else
            echo "âŒ ä¸»è¦å¯¼å‡ºæ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi
          
      - name: ğŸ§ª Package Structure Test
        if: steps.install.outputs.success == 'true'
        run: |
          cd /tmp/cosy-ui-test
          
          echo "ğŸ§ª æµ‹è¯•åŒ…ç»“æ„..."
          
          # æ£€æŸ¥åŒ…çš„åŸºæœ¬ä¿¡æ¯
          if [ -f "node_modules/@coffic/cosy-ui/package.json" ]; then
            echo "âœ… package.json å­˜åœ¨"
            PACKAGE_VERSION=$(cat node_modules/@coffic/cosy-ui/package.json | grep '"version"' | sed 's/.*"version": "\(.*\)".*/\1/')
            echo "ğŸ“¦ åŒ…ç‰ˆæœ¬: $PACKAGE_VERSION"
          else
            echo "âŒ package.json ä¸å­˜åœ¨"
            exit 1
          fi
          
          # æ£€æŸ¥å…³é”®æ–‡ä»¶ç»“æ„
          REQUIRED_FILES=(
            "node_modules/@coffic/cosy-ui/dist/index-astro.ts"
            "node_modules/@coffic/cosy-ui/dist/src-astro/"
            "node_modules/@coffic/cosy-ui/dist/app.css"
          )
          
          for file in "${REQUIRED_FILES[@]}"; do
            if [ -e "$file" ]; then
              echo "âœ… å…³é”®æ–‡ä»¶å­˜åœ¨: $file"
            else
              echo "âŒ å…³é”®æ–‡ä»¶ç¼ºå¤±: $file"
              exit 1
            fi
          done
          
          # æ£€æŸ¥ä¸€äº›é‡è¦çš„ç»„ä»¶ç›®å½•
          COMPONENT_DIRS=(
            "node_modules/@coffic/cosy-ui/dist/src-astro/alert"
            "node_modules/@coffic/cosy-ui/dist/src-astro/button"
            "node_modules/@coffic/cosy-ui/dist/src-astro/card"
          )
          
          for dir in "${COMPONENT_DIRS[@]}"; do
            if [ -d "$dir" ]; then
              echo "âœ… ç»„ä»¶ç›®å½•å­˜åœ¨: $dir"
            else
              echo "âŒ ç»„ä»¶ç›®å½•ç¼ºå¤±: $dir"
              exit 1
            fi
          done
          
          echo "âœ… åŒ…ç»“æ„æ£€æŸ¥å®Œæˆ"
          
      - name: ğŸŒ Check Documentation Website
        run: |
          echo "ğŸŒ æ£€æŸ¥æ–‡æ¡£ç½‘ç«™å¯è®¿é—®æ€§..."
          
          # æ£€æŸ¥ä¸»é¡µ
          MAIN_URL="https://cofficlab.github.io/cosy-ui/en/courses/guide/"
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$MAIN_URL")
          
          if [ "$HTTP_STATUS" = "200" ]; then
            echo "âœ… æ–‡æ¡£ç½‘ç«™ä¸»é¡µå¯è®¿é—® ($HTTP_STATUS)"
          else
            echo "âŒ æ–‡æ¡£ç½‘ç«™ä¸»é¡µè®¿é—®å¤±è´¥ (HTTP $HTTP_STATUS)"
            exit 1
          fi
          
          # æ£€æŸ¥å…³é”®é¡µé¢
          PAGES=(
            "https://cofficlab.github.io/cosy-ui/en/courses/guide/installation/"
            "https://cofficlab.github.io/cosy-ui/en/courses/components/alert/"
            "https://cofficlab.github.io/cosy-ui/en/courses/components/button/"
          )
          
          for page in "${PAGES[@]}"; do
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$page")
            if [ "$HTTP_STATUS" = "200" ]; then
              echo "âœ… é¡µé¢å¯è®¿é—®: $page ($HTTP_STATUS)"
            else
              echo "âš ï¸  é¡µé¢è®¿é—®å¼‚å¸¸: $page (HTTP $HTTP_STATUS)"
            fi
          done
          
  # æ±‡æ€»æ£€æŸ¥ç»“æœ
  summary:
    name: ğŸ“Š Health Check Summary
    runs-on: ubuntu-latest
    needs: health-check
    if: always()
    
    steps:
      - name: ğŸ“Š Generate Summary
        run: |
          echo "ğŸ¥ Cosy UI å¥åº·æ£€æŸ¥å®Œæˆ"
          echo ""
          echo "ğŸ“‹ æ£€æŸ¥ç»“æœæ±‡æ€»ï¼š"
          echo "- åŒ…ç®¡ç†å™¨æµ‹è¯•: npm, yarn, pnpm"
          echo "- Node.js ç‰ˆæœ¬æµ‹è¯•: 18, 20, 22"
          echo "- æ–‡æ¡£ç½‘ç«™æ£€æŸ¥: âœ… å®Œæˆ"
          echo ""
          echo "ğŸ”— ç›¸å…³é“¾æ¥ï¼š"
          echo "- ğŸ“¦ NPM åŒ…: https://www.npmjs.com/package/@coffic/cosy-ui"
          echo "- ğŸ“š æ–‡æ¡£ç½‘ç«™: https://cofficlab.github.io/cosy-ui/en/courses/guide/"
          echo "- ğŸ™ GitHub ä»“åº“: https://github.com/CofficLab/cosy-ui"
          
      - name: ğŸš¨ Create Issue on Failure
        if: needs.health-check.result == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const now = new Date().toISOString();
            const title = `ğŸš¨ Health Check Failed - ${now}`;
            const body = `
            ## ğŸš¨ å¥åº·æ£€æŸ¥å¤±è´¥
            
            **æ—¶é—´**: ${now}
            **å·¥ä½œæµ**: [Health Check](${context.payload.repository.html_url}/actions/runs/${context.runId})
            
            ### ğŸ“‹ æ£€æŸ¥é¡¹ç›®
            - âŒ åŒ…ç®¡ç†å™¨å®‰è£…æµ‹è¯• (npm, yarn, pnpm)
            - âŒ å¤šç‰ˆæœ¬ Node.js å…¼å®¹æ€§æµ‹è¯•
            - âŒ æ–‡æ¡£ç½‘ç«™å¯è®¿é—®æ€§æ£€æŸ¥
            
            ### ğŸ”— ç›¸å…³é“¾æ¥
            - ğŸ“¦ [NPM åŒ…](https://www.npmjs.com/package/@coffic/cosy-ui)
            - ğŸ“š [æ–‡æ¡£ç½‘ç«™](https://cofficlab.github.io/cosy-ui/en/courses/guide/)
            - ğŸ™ [GitHub ä»“åº“](https://github.com/CofficLab/cosy-ui)
            
            ### ğŸ› ï¸ å»ºè®®æ“ä½œ
            1. æ£€æŸ¥æœ€æ–°å‘å¸ƒçš„åŒ…æ˜¯å¦æ­£å¸¸
            2. éªŒè¯æ–‡æ¡£ç½‘ç«™çš„éƒ¨ç½²çŠ¶æ€
            3. æŸ¥çœ‹è¯¦ç»†çš„é”™è¯¯æ—¥å¿—
            
            ---
            *æ­¤ Issue ç”±å¥åº·æ£€æŸ¥å·¥ä½œæµè‡ªåŠ¨åˆ›å»º*
            `;
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['ğŸš¨ health-check', 'ğŸ› bug', 'ğŸ”¥ urgent']
            }); 