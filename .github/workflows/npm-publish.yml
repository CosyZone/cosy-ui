name: ğŸ“¦ Publish to npm

on:
    push:
        branches:
            - npm
        
    workflow_dispatch:
        inputs:
            force_publish:
                description: 'å¼ºåˆ¶å‘å¸ƒï¼ˆå¿½ç•¥ç‰ˆæœ¬æ£€æŸ¥ï¼‰'
                required: false
                default: false
                type: boolean
            version:
                description: 'æŒ‡å®šç‰ˆæœ¬å·ï¼ˆç•™ç©ºåˆ™ä½¿ç”¨ package.json ä¸­çš„ç‰ˆæœ¬ï¼‰'
                required: false
                default: ''
                type: string

    workflow_run:
        workflows:
            - "ğŸ“¦ Release Cosy UI"
        types:
            - completed

permissions:
  id-token: write  # Required for OIDC
  contents: read

jobs:
    publish:
        runs-on: ubuntu-latest
        if: |
            github.event.workflow_run.conclusion == 'success' &&
            github.event.workflow_run.head_branch == 'main'
        permissions:
            contents: read
            id-token: write
        steps:
            - uses: actions/checkout@v4
            - uses: actions/setup-node@v4
              with:
                  node-version: "23"
            - name: Setup PNPM
              uses: pnpm/action-setup@v2
              with:
                  version: 10
            - name: Update npm to latest version
              run: npm install -g npm@latest
            - name: Publish Package
              run: |
                  cd packages/cosy-ui
                  echo "Current package version:"
                  cat package.json | grep version
                  echo "Current npm version:"
                  npm view @coffic/cosy-ui version
                  pnpm i
                  pnpm build:prod
                  npm publish --access public --no-git-checks
