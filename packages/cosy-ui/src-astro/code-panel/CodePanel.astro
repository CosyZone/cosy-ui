---
/**
 * @component CodePanel
 *
 * @description
 * ä»£ç å±•ç¤ºé¢æ¿ç»„ä»¶ï¼Œæ”¯æŒè¯­æ³•é«˜äº®ã€å¤šä¸»é¢˜åˆ‡æ¢å’Œè¡Œå·æ˜¾ç¤ºã€‚
 * åŸºäº Shiki æä¾›é«˜è´¨é‡çš„ä»£ç é«˜äº®æ•ˆæœï¼Œä¸ VS Code ä¿æŒä¸€è‡´çš„æ¸²æŸ“æ•ˆæœã€‚
 * æ”¯æŒæœåŠ¡ç«¯æ¸²æŸ“ï¼Œæ— éœ€å®¢æˆ·ç«¯ JavaScript å³å¯å±•ç¤ºä»£ç é«˜äº®ã€‚
 *
 * @features
 * - ğŸ¨ è¯­æ³•é«˜äº®ï¼šåŸºäº Shikiï¼Œæ”¯æŒ 180+ ç¼–ç¨‹è¯­è¨€
 * - ğŸ­ å¤šä¸»é¢˜ï¼šæ”¯æŒ VS Code ä¸»é¢˜ï¼ˆdark-plusã€light-plusã€github-dark ç­‰ï¼‰
 * - ğŸ“ è¡Œå·æ˜¾ç¤ºï¼šå¯é€‰çš„è¡Œå·æ˜¾ç¤ºåŠŸèƒ½
 * - ğŸš€ æ€§èƒ½ä¼˜åŒ–ï¼šæœåŠ¡ç«¯æ¸²æŸ“ï¼Œé¿å…å®¢æˆ·ç«¯é‡å¤è®¡ç®—
 * - ğŸ“± å“åº”å¼ï¼šè‡ªé€‚åº”ä¸åŒå±å¹•å°ºå¯¸
 * - ğŸ¯ å¯è®¿é—®æ€§ï¼šè¯­ä¹‰åŒ– HTML ç»“æ„ï¼Œæ”¯æŒé”®ç›˜å¯¼èˆª
 *
 * @usage
 * åŸºæœ¬ç”¨æ³•ï¼š
 * ```astro
 * <CodePanel code="console.log('Hello, world!');" />
 * ```
 *
 * æŒ‡å®šè¯­è¨€å’Œä¸»é¢˜ï¼š
 * ```astro
 * <CodePanel
 *   code="const name = 'TypeScript';"
 *   language="typescript"
 *   theme="github-dark"
 *   showLineNumbers={true}
 * />
 * ```
 *
 * åœ¨åˆ‡æ¢é¢æ¿ä¸­ä½¿ç”¨ï¼š
 * ```astro
 * <CodePanel
 *   code={sourceCode}
 *   language="astro"
 *   visible={false}
 * />
 * ```
 *
 * @props
 * @param {string} code - è¦æ˜¾ç¤ºçš„ä»£ç å­—ç¬¦ä¸²
 * @param {string} [language="typescript"] - ä»£ç è¯­è¨€ï¼Œç”¨äºè¯­æ³•é«˜äº®
 * @param {string} [theme="dark-plus"] - ä¸»é¢˜åç§°
 * @param {boolean} [showLineNumbers=false] - æ˜¯å¦æ˜¾ç¤ºè¡Œå·
 * @param {boolean} [visible=true] - æ˜¯å¦æ˜¾ç¤ºåœ¨é¢æ¿ä¸­
 * @param {string} [class] - è‡ªå®šä¹‰ç±»å
 *
 * @slots
 * æ­¤ç»„ä»¶ä¸åŒ…å«æ’æ§½ï¼Œé€šè¿‡ props ä¼ å…¥ä»£ç å†…å®¹
 *
 * @accessibility
 * - ä½¿ç”¨è¯­ä¹‰åŒ–çš„ HTML ç»“æ„
 * - ä»£ç åŒºåŸŸå…·æœ‰é€‚å½“çš„ aria æ ‡ç­¾
 * - æ”¯æŒé”®ç›˜å¯¼èˆªå’Œå±å¹•é˜…è¯»å™¨
 * - é«˜å¯¹æ¯”åº¦ä¸»é¢˜æ”¯æŒ
 */
import type { CodePanelProps } from './types';
import '../../style.ts';

interface Props extends CodePanelProps {}

const {
  code = '',
  language = 'typescript',
  theme = 'dark-plus',
  showLineNumbers = false,
  visible = true,
  class: className = '',
} = Astro.props;

// ä¼˜åŒ– Shiki åŠ è½½ - ä½¿ç”¨åŠ¨æ€å¯¼å…¥é¿å…æ„å»ºæ—¶åˆ›å»ºå¤šä¸ªå®ä¾‹
let highlightedCode = code;
try {
  // ä½¿ç”¨åŠ¨æ€å¯¼å…¥é¿å…æ„å»ºæ—¶çš„æ€§èƒ½é—®é¢˜
  const { createHighlighter } = await import('shiki');

  const highlighter = await createHighlighter({
    themes: [theme],
    langs: [language],
  });

  highlightedCode = highlighter.codeToHtml(code, {
    lang: language,
    theme: theme,
    transformers: [],
  });

  // é‡Šæ”¾èµ„æº
  highlighter.dispose?.();
} catch (error) {
  console.warn(
    'CodePanel: Shiki highlighting failed, falling back to plain text:',
    error
  );
  // é™çº§åˆ°æ™®é€šä»£ç å—
  highlightedCode = `<pre><code>${code}</code></pre>`;
}
---

<div data-panel="code" role="region" aria-label="ä»£ç å±•ç¤ºé¢æ¿">
  <!-- Shiki æ¸²æŸ“çš„ä»£ç  -->
  <div
    class="cosy:w-full not-prose cosy-shiki-container"
    set:html={highlightedCode}
  />
</div>
