---
/**
 * AppLayout组件
 *
 * 适用于页面布局，包含头部导航、侧边栏导航和目录
 *
 * 布局效果：
 *
 * 移动端：
 * ```
 * +------------------+
 * |     Header      |
 * +------------------+
 * | Sidebar (1 line) |
 * +------------------+
 * |                  |
 * |   Main Content   |
 * |                  |
 * |                  |
 * +------------------+
 * |     Footer      |
 * +------------------+
 * ```
 *
 * 桌面端：
 * ```
 * +------------------+
 * |      Header     |
 * +--------+---------+
 * |        |         |
 * |Sidebar | Content |
 * |        |         |
 * |        |         |
 * +--------+---------+
 * |      Footer     |
 * +------------------+
 * ```
 *
 * @param {Object} sidebarConfig - 侧边栏配置
 * @param {boolean} [showHeader=true] - 是否显示头部
 * @param {boolean} [showFooter=true] - 是否显示页脚
 * @param {boolean} [showSidebar=true] - 是否显示侧边栏
 * @param {string} [className] - 自定义类名
 * @param {Array} [classList] - 自定义类名列表
 * @param {boolean} [debug=true] - 是否启用调试模式
 * @param {Object} mainContentConfig - 主内容区域配置
 * @param {Object} footerConfig - 页脚配置
 * @param {Object} headerConfig - 头部配置（传递给AppHeader组件）
 * @param {Object} metaConfig - 元数据配置
 * @param {Object} rest - 其他属性
 *
 * @slot default - 主内容区域
 * @slot navbar-start - 导航栏开始位置的内容（传递给AppHeader）
 * @slot navbar-center - 导航栏中间位置的内容（传递给AppHeader）
 * @slot navbar-end - 导航栏结束位置的内容（传递给AppHeader）
 * @slot modal-search - 搜索模态框内容，当提供此slot时会显示搜索按钮（传递给AppHeader）
 *
 * @example
 * ```astro
 * ---
 * import AppLayout from '../layouts/AppLayout.astro';
 *
 * const sidebarItems = [
 *   { title: "入门", items: [
 *     { href: "/docs/getting-started", text: "快速开始" },
 *     { href: "/docs/installation", text: "安装" }
 *   ]},
 *   { title: "组件", items: [
 *     { href: "/docs/components/button", text: "Button 按钮" },
 *     { href: "/docs/components/card", text: "Card 卡片" }
 *   ]}
 * ];
 * ---
 *
 * <AppLayout
 *   metaConfig={{
 *     title: "文档标题",
 *     description: "文档描述"
 *   }}
 *   sidebarConfig={{
 *     sidebarItems: sidebarItems
 *   }}
 * >
 *   <h1>文档内容</h1>
 *   <p>这是文档的主要内容</p>
 * </AppLayout>
 * ```
 *
 * 自定义页脚示例：
 * ```astro
 * <AppLayout
 *   metaConfig={{
 *     title: "文档标题",
 *     description: "文档描述"
 *   }}
 *   sidebarConfig={{
 *     sidebarItems: sidebarItems
 *   }}
 *   footerConfig={{
 *     slogan: "简单而强大的组件库",
 *     inspirationalSlogan: "让开发更加愉悦",
 *     socialLinks: [
 *       "https://github.com/myorg/myrepo",
 *       "https://twitter.com/myorg"
 *     ],
 *     products: [
 *       { name: "组件库", href: "/components" },
 *       { name: "模板", href: "/templates" }
 *     ]
 *   }}
 * >
 *   <h1>文档内容</h1>
 *   <p>这是文档的主要内容</p>
 * </AppLayout>
 * ```
 *
 * 组件支持多种页脚相关的配置参数，可以通过以 `footer` 为前缀的属性来自定义页脚的内容和链接。
 * 所有这些参数都是可选的，组件会为常用参数提供默认值。
 *
 * 全宽内容区域示例：
 * ```astro
 * <AppLayout
 *   metaConfig={{
 *     title: "文档标题",
 *     description: "文档描述"
 *   }}
 *   sidebarConfig={{
 *     sidebarItems: sidebarItems
 *   }}
 *   mainContentConfig={{
 *     fullWidth: true
 *   }}
 * >
 *   <!-- 全宽Hero部分，无需容器限制 -->
 *   <div class="cosy:bg-primary cosy:p-10 cosy:text-white cosy:text-center">
 *     <h1 class="cosy:text-3xl">全宽Hero部分</h1>
 *     <p class="cosy:mt-4">没有容器限制，宽度可以100%占满</p>
 *   </div>
 *
 *   <!-- 自定义容器部分 -->
 *   <div class="cosy:mx-auto cosy:p-6 cosy:container">
 *     <p>在全宽模式下，您可以自行控制内容的容器和间距</p>
 *     <p>这使得创建全宽背景的同时，保持内容在合适的宽度内</p>
 *   </div>
 *
 *   <!-- 另一个全宽部分 -->
 *   <div class="cosy:bg-accent cosy:mt-8 cosy:p-10">
 *     <div class="cosy:mx-auto cosy:container">
 *       <h2 class="cosy:text-2xl">灵活的布局</h2>
 *       <p>您可以自由组合全宽区域和容器限制区域</p>
 *     </div>
 *   </div>
 * </AppLayout>
 * ```
 *
 * 调试模式示例：
 * ```astro
 * <AppLayout
 *   metaConfig={{
 *     title: "文档标题",
 *     description: "文档描述"
 *   }}
 *   sidebarConfig={{
 *     sidebarItems: sidebarItems
 *   }}
 *   debug={true}
 * >
 *   <h1>文档内容</h1>
 *   <p>这是文档的主要内容</p>
 * </AppLayout>
 * ```
 *
 * 自定义导航栏示例：
 * ```astro
 * <AppLayout
 *   metaConfig={{
 *     title: "文档标题",
 *     description: "文档描述"
 *   }}
 *   sidebarConfig={{
 *     sidebarItems: sidebarItems
 *   }}
 * >
 *   <!-- 导航栏开始位置 -->
 *   <div slot="navbar-start">
 *     <h1 class="cosy:text-xl cosy:font-bold">我的应用</h1>
 *   </div>
 *
 *   <!-- 导航栏中间位置 -->
 *   <div slot="navbar-center">
 *     <nav class="cosy:flex cosy:gap-4">
 *       <a href="/docs" class="cosy:link cosy:link-hover">文档</a>
 *       <a href="/components" class="cosy:link cosy:link-hover">组件</a>
 *       <a href="/examples" class="cosy:link cosy:link-hover">示例</a>
 *     </nav>
 *   </div>
 *
 *   <!-- 导航栏结束位置 -->
 *   <div slot="navbar-end">
 *     <button class="cosy:btn cosy:btn-primary">登录</button>
 *   </div>
 *
 *   <h1>文档内容</h1>
 *   <p>这是文档的主要内容</p>
 * </AppLayout>
 * ```
 *
 * 搜索功能示例：
 * ```astro
 * <AppLayout
 *   metaConfig={{
 *     title: "文档标题",
 *     description: "文档描述"
 *   }}
 *   sidebarConfig={{
 *     sidebarItems: sidebarItems
 *   }}
 * >
 *   <h1>文档内容</h1>
 *   <p>这是文档的主要内容</p>
 *
 *   <!-- 提供搜索模态框内容，会自动显示搜索按钮 -->
 *   <div slot="modal-search">
 *     <div class="cosy:space-y-4">
 *       <input
 *         type="text"
 *         placeholder="搜索文档..."
 *         class="cosy:input cosy:input-bordered cosy:w-full"
 *       />
 *       <div class="cosy:flex cosy:gap-2">
 *         <button class="cosy:btn cosy:btn-primary">搜索</button>
 *         <button class="cosy:btn cosy:btn-ghost">清除</button>
 *       </div>
 *     </div>
 *   </div>
 * </AppLayout>
 * ```
 */

import '../../style.ts';
import {
  BaseLayout,
  type IAppLayoutProps,
  Footer,
  Container,
  Main,
  Sidebar,
  Modal,
} from '../../index-astro';
import AppHeader from './AppHeader.astro';
import SkeletonLoader from './SkeletonLoader.astro';

interface Props extends IAppLayoutProps {}

const {
  sidebarConfig,
  showHeader = true,
  showFooter = true,
  showSidebar = true,
  class: className,
  'class:list': classList,
  debug = false,
  mainContentConfig,
  footerConfig,
  headerConfig,
  metaConfig,
  loadingDelay = 100,
  ...rest
}: Props = Astro.props;

// 动态计算Container最小高度
function getContainerMinHeightClass(headerHeight: string = 'md') {
  const heightValueMap = {
    '3xs': 'cosy:min-h-[calc(100vh-1rem)]',
    '2xs': 'cosy:min-h-[calc(100vh-1.5rem)]',
    xs: 'cosy:min-h-[calc(100vh-2rem)]',
    sm: 'cosy:min-h-[calc(100vh-2.5rem)]',
    md: 'cosy:min-h-[calc(100vh-3rem)]',
    lg: 'cosy:min-h-[calc(100vh-4rem)]',
    xl: 'cosy:min-h-[calc(100vh-5rem)]',
  };
  return (
    heightValueMap[headerHeight as keyof typeof heightValueMap] ||
    'cosy:min-h-[calc(100vh-3rem)]'
  );
}

const containerMinHeightClass = getContainerMinHeightClass(
  headerConfig?.height
);

// 计算Sidebar的top值和高度值
function getSidebarTopClass(headerHeight: string = 'md') {
  const topMap = {
    '3xs': 'cosy:top-4',
    '2xs': 'cosy:top-6',
    xs: 'cosy:top-8',
    sm: 'cosy:top-10',
    md: 'cosy:top-12',
    lg: 'cosy:top-16',
    xl: 'cosy:top-20',
  };
  return topMap[headerHeight as keyof typeof topMap] || 'cosy:top-12';
}

function getSidebarHeightClass(headerHeight: string = 'md') {
  const heightValueMap = {
    '3xs': 'cosy:h-[calc(100vh-1rem)]',
    '2xs': 'cosy:h-[calc(100vh-1.5rem)]',
    xs: 'cosy:h-[calc(100vh-2rem)]',
    sm: 'cosy:h-[calc(100vh-2.5rem)]',
    md: 'cosy:h-[calc(100vh-3rem)]',
    lg: 'cosy:h-[calc(100vh-4rem)]',
    xl: 'cosy:h-[calc(100vh-5rem)]',
  };
  return (
    heightValueMap[headerHeight as keyof typeof heightValueMap] ||
    'cosy:h-[calc(100vh-3rem)]'
  );
}

const sidebarTopClass = getSidebarTopClass(headerConfig?.height);
const sidebarHeightClass = getSidebarHeightClass(headerConfig?.height);
---

<BaseLayout {...metaConfig} debug={debug}>
  {
    showHeader && (
      <AppHeader
        headerConfig={headerConfig}
        debug={debug}
        showSidebar={showSidebar}
        showSearch={Astro.slots.has('modal-search')}>
        <slot name="navbar-start" slot="navbar-start" />
        <slot name="navbar-center" slot="navbar-center" />
        <slot name="navbar-end" slot="navbar-end" />
      </AppHeader>
    )
  }

  <Container
    flex="row"
    gap="none"
    size="full"
    padding="none"
    class={containerMinHeightClass}>
    <!-- 侧边栏容器 -->
    {
      showSidebar && (
        <Sidebar
          {...sidebarConfig}
          topClass={sidebarTopClass}
          heightClass={sidebarHeightClass}
        />
      )
    }

    <!-- 主内容区域 -->
    <Main {...mainContentConfig} class="cosy:flex-1 cosy:min-w-xs">
      <SkeletonLoader
        showLoading={true}
        loadingSize="xl"
        loadingDelay={loadingDelay}
        skeletonClass="cosy:w-full cosy:h-screen cosy:flex cosy:items-center cosy:justify-center">
        <slot />
      </SkeletonLoader>
    </Main>
  </Container>

  <!-- Footer -->
  {
    showFooter && (
      <Container size="full" padding="none">
        <Footer {...footerConfig} />
      </Container>
    )
  }

  <!-- 搜索模态框 -->
  {
    Astro.slots.has('modal-search') && (
      <Modal id="modalSearch" title="搜索">
        <slot name="modal-search" />
      </Modal>
    )
  }

  <script>
    // Handle sidebar toggle
    const sidebarToggle = document.getElementById('sidebar-toggle');
    const sidebar = document.getElementById('sidebar-mobile');
    const sidebarOverlay = document.getElementById('sidebar-overlay');

    function toggleSidebar() {
      sidebar?.classList.toggle('cosy:hidden');
      sidebarOverlay?.classList.toggle('cosy:hidden');
      document.body.classList.toggle('cosy:overflow-hidden');
    }

    sidebarToggle?.addEventListener('click', toggleSidebar);
    sidebarOverlay?.addEventListener('click', toggleSidebar);
  </script>
</BaseLayout>
