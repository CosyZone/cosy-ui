---
/**
 * @component DashboardLayout
 *
 * @description
 * DashboardLayout ç»„ä»¶é€‚ç”¨äºç®¡ç†åå°çš„å¸ƒå±€ï¼ŒåŒ…å«ä¾§è¾¹æ å¯¼èˆªå’Œé¡¶éƒ¨å¯¼èˆªæ ã€‚
 * æä¾›äº†å®Œæ•´çš„ç®¡ç†ç•Œé¢æ¡†æ¶ï¼ŒåŒ…æ‹¬å“åº”å¼è®¾è®¡å’Œæš—è‰²ä¸»é¢˜æ”¯æŒã€‚
 *
 * @design
 * è®¾è®¡ç†å¿µï¼š
 * 1. æ¸…æ™°çš„ä¿¡æ¯å±‚æ¬¡ - é€šè¿‡ä¾§è¾¹æ å’Œé¡¶éƒ¨å¯¼èˆªæä¾›æ˜ç¡®çš„å¯¼èˆªç»“æ„
 * 2. å“åº”å¼å¸ƒå±€ - åœ¨ä¸åŒè®¾å¤‡ä¸Šæä¾›è‰¯å¥½çš„ç”¨æˆ·ä½“éªŒ
 * 3. å¯å®šåˆ¶æ€§ - æ”¯æŒè‡ªå®šä¹‰å¯¼èˆªé¡¹ã€ç³»ç»Ÿåç§°å’Œç”¨æˆ·ä¿¡æ¯
 * 4. çŠ¶æ€ä¿æŒ - è®°ä½ç”¨æˆ·çš„ä¾§è¾¹æ æŠ˜å çŠ¶æ€
 *
 * @usage
 * ```astro
 * ---
 * import { DashboardLayout } from '@coffic/cosy-ui';
 *
 * const navItems = [
 *   { href: "/dashboard", icon: "home", text: "ä»ªè¡¨ç›˜" },
 *   { href: "/dashboard/users", icon: "user", text: "ç”¨æˆ·ç®¡ç†" },
 *   { href: "/dashboard/settings", icon: "settings", text: "ç³»ç»Ÿè®¾ç½®" }
 * ];
 * ---
 *
 * <DashboardLayout
 *   title="ç®¡ç†åå°"
 *   navItems={navItems}
 *   userName="ç®¡ç†å‘˜"
 * >
 *   <h1>ä»ªè¡¨ç›˜å†…å®¹</h1>
 *   <p>è¿™æ˜¯ä»ªè¡¨ç›˜çš„ä¸»è¦å†…å®¹</p>
 * </DashboardLayout>
 * ```
 *
 * @props
 * - title: string - é¡µé¢æ ‡é¢˜
 * - description?: string - é¡µé¢æè¿°
 * - systemName?: string - ç³»ç»Ÿåç§°ï¼Œé»˜è®¤ä¸º"ç®¡ç†ç³»ç»Ÿ"
 * - navItems: NavItem[] - å¯¼èˆªé¡¹ç›®
 * - userName?: string - ç”¨æˆ·å
 * - userAvatar?: string - ç”¨æˆ·å¤´åƒ
 * - sidebarCollapsed?: boolean - æ˜¯å¦æŠ˜å ä¾§è¾¹æ ï¼Œé»˜è®¤ä¸ºfalse
 * - head?: astroHTML.JSX.Element - è‡ªå®šä¹‰å¤´éƒ¨å†…å®¹
 * - class?: string - é¡µé¢ç±»å
 * - class:list?: any - ç±»ååˆ—è¡¨
 *
 * @slots
 * - default - ä¸»è¦å†…å®¹åŒºåŸŸ
 */

import { BaseLayout } from '../../index-astro';
import '../../style.ts';

export interface NavItem {
  href: string;
  icon: string;
  text: string;
  badge?: string | number;
  items?: NavItem[];
}

export interface Props {
  /**
   * é¡µé¢æ ‡é¢˜
   */
  title: string;

  /**
   * é¡µé¢æè¿°
   */
  description?: string;

  /**
   * ç³»ç»Ÿåç§°
   * @default "ç®¡ç†ç³»ç»Ÿ"
   */
  systemName?: string;

  /**
   * å¯¼èˆªé¡¹ç›®
   */
  navItems: NavItem[];

  /**
   * ç”¨æˆ·å
   */
  userName?: string;

  /**
   * ç”¨æˆ·å¤´åƒ
   */
  userAvatar?: string;

  /**
   * æ˜¯å¦æŠ˜å ä¾§è¾¹æ 
   * @default false
   */
  sidebarCollapsed?: boolean;

  /**
   * è‡ªå®šä¹‰å¤´éƒ¨å†…å®¹
   */
  head?: astroHTML.JSX.Element;

  /**
   * é¡µé¢ç±»å
   */
  class?: string;

  /**
   * ç±»ååˆ—è¡¨
   */
  'class:list'?: any;
}

const {
  title,
  description,
  systemName = 'ç®¡ç†ç³»ç»Ÿ',
  navItems,
  userName,
  userAvatar,
  sidebarCollapsed = false,
  head,
  class: className,
  'class:list': classList,
  ...rest
} = Astro.props;

const currentPath = Astro.url.pathname;

// å›¾æ ‡æ˜ å°„
const iconMap: Record<string, string> = {
  home: 'ğŸ ',
  user: 'ğŸ‘¤',
  users: 'ğŸ‘¥',
  settings: 'âš™ï¸',
  chart: 'ğŸ“Š',
  document: 'ğŸ“„',
  calendar: 'ğŸ“…',
  notification: 'ğŸ””',
  message: 'ğŸ’¬',
  search: 'ğŸ”',
  star: 'â­',
  heart: 'â¤ï¸',
  menu: 'â˜°',
};
---

<BaseLayout
  title={title}
  description={description || ''}
  head={head}
  keywords=""
  author=""
  robots=""
  class:list={['cosy:min-h-screen cosy:bg-base-200', className, classList]}
  {...rest}>
  <div class:list={['cosy:drawer', { 'cosy:drawer-open': !sidebarCollapsed }]}>
    <input id="dashboard-drawer" type="checkbox" class="cosy:drawer-toggle" />

    <!-- ä¾§è¾¹æ  -->
    <div class="cosy:drawer-side">
      <label
        for="dashboard-drawer"
        aria-label="close sidebar"
        class="cosy:drawer-overlay"></label>
      <aside
        class="cosy:w-64 cosy:min-h-full cosy:bg-base-300 cosy:text-base-content">
        <!-- ä¾§è¾¹æ å¤´éƒ¨ -->
        <div
          class="cosy:navbar cosy:bg-base-300 cosy:border-b cosy:border-base-200">
          <div class="cosy:navbar-start">
            <a
              href="/dashboard"
              class="cosy:btn cosy:btn-ghost cosy:text-lg cosy:font-semibold cosy:no-underline">
              <span class="cosy:text-xl">âš¡</span>
              <span class="cosy:hidden cosy:lg:block">{systemName}</span>
            </a>
          </div>
          <div class="cosy:navbar-end">
            <button
              class="cosy:btn cosy:btn-ghost cosy:btn-sm"
              id="collapse-sidebar">
              <span class="cosy:text-sm">{iconMap.menu}</span>
            </button>
          </div>
        </div>

        <!-- å¯¼èˆªèœå• -->
        <ul
          class="cosy:menu cosy:p-4 cosy:space-y-1 cosy:list-none cosy:no-underline">
          {
            navItems.map((item: NavItem) => {
              const isActive =
                currentPath === item.href ||
                (item.items &&
                  item.items.some(
                    (subitem: NavItem) => currentPath === subitem.href
                  ));

              return (
                <li>
                  <a
                    href={item.href}
                    class:list={['cosy:no-underline', { active: isActive }]}>
                    <span class="cosy:text-base">
                      {iconMap[item.icon] || 'ğŸ“'}
                    </span>
                    <span>{item.text}</span>
                    {item.badge && (
                      <span class="cosy:badge cosy:badge-primary cosy:badge-sm">
                        {item.badge}
                      </span>
                    )}
                  </a>

                  {item.items && (
                    <ul class="cosy:ml-4 cosy:list-none cosy:no-underline">
                      {item.items.map((subitem: NavItem) => {
                        const isSubActive = currentPath === subitem.href;
                        return (
                          <li>
                            <a
                              href={subitem.href}
                              class:list={[
                                'cosy:text-sm cosy:no-underline',
                                { active: isSubActive },
                              ]}>
                              <span class="cosy:text-sm">
                                {iconMap[subitem.icon] || 'ğŸ“„'}
                              </span>
                              <span>{subitem.text}</span>
                              {subitem.badge && (
                                <span class="cosy:badge cosy:badge-primary cosy:badge-xs">
                                  {subitem.badge}
                                </span>
                              )}
                            </a>
                          </li>
                        );
                      })}
                    </ul>
                  )}
                </li>
              );
            })
          }
        </ul>
      </aside>
    </div>

    <!-- ä¸»å†…å®¹åŒº -->
    <div class="cosy:drawer-content cosy:flex cosy:flex-col">
      <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
      <div class="cosy:navbar cosy:bg-base-100 cosy:shadow-sm">
        <div class="cosy:navbar-start">
          <label
            for="dashboard-drawer"
            class="cosy:btn cosy:btn-square cosy:btn-ghost cosy:lg:hidden">
            <span class="cosy:text-lg">{iconMap.menu}</span>
          </label>

          <div class="cosy:breadcrumbs cosy:text-sm cosy:ml-4">
            <ul>
              <li><span class="cosy:text-base-content/70">{title}</span></li>
            </ul>
          </div>
        </div>

        <div class="cosy:navbar-end cosy:gap-2">
          <!-- æœç´¢æ¡† -->
          <div class="cosy:form-control cosy:hidden cosy:lg:flex">
            <div class="cosy:input-group">
              <input
                type="text"
                placeholder="æœç´¢..."
                class="cosy:input cosy:input-bordered cosy:input-sm cosy:w-48"
              />
              <button class="cosy:btn cosy:btn-square cosy:btn-sm">
                <span class="cosy:text-sm">{iconMap.search}</span>
              </button>
            </div>
          </div>

          <!-- é€šçŸ¥ -->
          <div class="cosy:indicator">
            <button class="cosy:btn cosy:btn-ghost cosy:btn-circle">
              <span class="cosy:text-lg">{iconMap.notification}</span>
            </button>
            <span
              class="cosy:badge cosy:badge-xs cosy:badge-primary cosy:indicator-item"
              >3</span
            >
          </div>

          <!-- ç”¨æˆ·ä¿¡æ¯ -->
          {
            userName && (
              <div class="cosy:dropdown cosy:dropdown-end">
                <div
                  tabindex="0"
                  role="button"
                  class="cosy:btn cosy:btn-ghost cosy:gap-2">
                  {userAvatar ? (
                    <div class="cosy:avatar">
                      <div class="cosy:w-8 cosy:rounded-full">
                        <img src={userAvatar} alt={userName} />
                      </div>
                    </div>
                  ) : (
                    <div class="cosy:avatar cosy:placeholder">
                      <div class="cosy:bg-primary cosy:text-primary-content cosy:rounded-full cosy:w-8">
                        <span class="cosy:text-sm">{userName.charAt(0)}</span>
                      </div>
                    </div>
                  )}
                  <span class="cosy:hidden cosy:lg:block">{userName}</span>
                </div>
                <ul
                  tabindex="0"
                  class="cosy:dropdown-content cosy:menu cosy:p-2 cosy:shadow cosy:bg-base-100 cosy:rounded-box cosy:w-52">
                  <li>
                    <a class="cosy:no-underline">ä¸ªäººèµ„æ–™</a>
                  </li>
                  <li>
                    <a class="cosy:no-underline">è®¾ç½®</a>
                  </li>
                  <li>
                    <a class="cosy:no-underline">é€€å‡ºç™»å½•</a>
                  </li>
                </ul>
              </div>
            )
          }
        </div>
      </div>

      <!-- é¡µé¢å†…å®¹ -->
      <main class="cosy:flex-1 cosy:p-4 cosy:lg:p-6">
        <div class="cosy:card cosy:bg-base-100 cosy:shadow-sm">
          <div class="cosy:card-body">
            <slot />
          </div>
        </div>
      </main>
    </div>
  </div>
</BaseLayout>

<script>
  // ä¾§è¾¹æ æŠ˜å /å±•å¼€åŠŸèƒ½
  document.addEventListener('DOMContentLoaded', () => {
    const collapseSidebarBtn = document.getElementById('collapse-sidebar');
    const drawerToggle = document.getElementById(
      'dashboard-drawer'
    ) as HTMLInputElement;

    if (collapseSidebarBtn && drawerToggle) {
      collapseSidebarBtn.addEventListener('click', () => {
        drawerToggle.checked = !drawerToggle.checked;
        // ä¿å­˜çŠ¶æ€åˆ°æœ¬åœ°å­˜å‚¨
        localStorage.setItem(
          'sidebarCollapsed',
          drawerToggle.checked.toString()
        );
      });
    }

    // ä»æœ¬åœ°å­˜å‚¨æ¢å¤çŠ¶æ€
    const savedState = localStorage.getItem('sidebarCollapsed');
    if (savedState && drawerToggle) {
      drawerToggle.checked = savedState === 'true';
    }
  });
</script>
