---
/**
 * @component PictureBookPage
 *
 * @description
 * 绘本页面容器：固定宽高比、背景/覆盖插槽。
 * 背景图片100%填充整个页面，无安全区域限制。
 *
 * @usage
 * 基本用法：
 * ```astro
 * <PictureBookPage pageAspectRatio={3/4}>
 *   <PictureBookTextBox slot="overlay" top={8} left={50} width={48}>
 *     正文内容……
 *   </PictureBookTextBox>
 * </PictureBookPage>
 * ```
 *
 * 带背景色的用法：
 * ```astro
 * <PictureBookPage background="base-100/80" pageAspectRatio={3/4}>
 *   <PictureBookTextBox slot="overlay" top={8} left={50} width={48}>
 *     正文内容……
 *   </PictureBookTextBox>
 * </PictureBookPage>
 * ```
 *
 * 带背景图片的用法：
 * ```astro
 * import bgImage from '@/assets/hero.png';
 * <PictureBookPage background={bgImage} pageAspectRatio={3/4}>
 *   <PictureBookTextBox slot="overlay" top={8} left={50} width={48}>
 *     正文内容……
 *   </PictureBookTextBox>
 * </PictureBookPage>
 * ```
 *
 * 占满父容器用法：
 * ```astro
 * <PictureBookPage fillParent={true} pageAspectRatio={3/4}>
 *   <PictureBookTextBox slot="overlay" top={8} left={50} width={48}>
 *     正文内容……
 *   </PictureBookTextBox>
 * </PictureBookPage>
 * ```
 *
 * 在固定高度容器中使用：
 * ```astro
 * <div class="h-96 w-full">
 *   <PictureBookPage fillParent={true} pageAspectRatio={16/9}>
 *     <PictureBookTextBox slot="overlay" top={10} left={20} width={60}>
 *       内容……
 *     </PictureBookTextBox>
 *   </PictureBookPage>
 * </div>
 * ```
 *
 * 在响应式网格中使用：
 * ```astro
 * <div class="grid grid-cols-1 md:grid-cols-2 gap-4 h-64">
 *   <PictureBookPage fillParent={true} pageAspectRatio={4/3}>
 *     <PictureBookTextBox slot="overlay" top={5} left={10} width={80}>
 *       第一页内容
 *     </PictureBookTextBox>
 *   </PictureBookPage>
 *   <PictureBookPage fillParent={true} pageAspectRatio={4/3}>
 *     <PictureBookTextBox slot="overlay" top={5} left={10} width={80}>
 *       第二页内容
 *     </PictureBookTextBox>
 *   </PictureBookPage>
 * </div>
 * ```
 *
 * @props
 * - background?: BackgroundColor | ImageMetadata - 背景配置，支持背景色或图片。背景色如：base-100、primary/20、secondary/30 等；图片直接传递 ImageMetadata 对象
 * - pageAspectRatio?: number - 页面宽高比（宽/高），默认 3/4
 * - fillParent?: boolean - 是否占满父容器，默认 false。为 true 时组件会尽可能占满父容器并保持宽高比
 *
 * @slots
 * - overlay: 覆盖层插槽，相对安全区域进行绝对定位放置文本框/装饰
 * - default: 文字内容插槽，将按 `--pb-line` 行高进行排版
 */

import '../../style.ts';
import Container from '../container/Container.astro';
import type { BackgroundColor } from '../container/backgrounds';
import type { ImageMetadata } from 'astro';
import Image from '../image/Image.astro';

export interface IPictureBookPageProps {
  background?: BackgroundColor | ImageMetadata;
  pageAspectRatio?: number;
  fillParent?: boolean;
}

const {
  background,
  pageAspectRatio = 3 / 4,
  fillParent = false,
} = Astro.props as IPictureBookPageProps;

// 判断是否为图片类型
const isImageBackground =
  (typeof background === 'object' || typeof background === 'function') &&
  background !== null;
---

<Container
  background={isImageBackground ? undefined : (background as BackgroundColor)}
  width="full"
  padding="none"
  margin="none"
  rounded="xl"
  border={false}
  centered={false}
  aria-label="绘本页"
  class={`cosy:relative cosy:overflow-hidden cosy:shadow-lg cosy:ring-1 cosy:ring-black/5 ${
    fillParent ? 'cosy:h-full' : ''
  }`}>
  <!-- 页面容器：根据 fillParent 属性决定高度策略 -->
  <div
    class={`cosy:relative cosy:w-full ${fillParent ? 'cosy:h-full' : ''}`}
    style={fillParent
      ? ''
      : `padding-bottom: ${100 / (pageAspectRatio || 0.75)}%`}>
    <!-- 背景层：自动显示背景色或图片 -->
    <div class="cosy:absolute cosy:inset-0 cosy:w-full cosy:h-full">
      {
        isImageBackground && (
          <Image
            src={background as ImageMetadata}
            alt="页面背景"
            class="cosy:w-full cosy:h-full cosy:object-cover"
          />
        )
      }
    </div>

    <!-- 纸张质感或亮度覆盖，可按需微调，这里保持透明占位 -->
    <div
      class="cosy:absolute cosy:inset-0 cosy:pointer-events-none cosy:bg-white/0">
    </div>

    <!-- 内容容器：100%填充整个页面 -->
    <div class="cosy:absolute cosy:inset-0">
      <div
        class="cosy:relative cosy:h-full cosy:w-full"
        style="container-type: inline-size">
        <!-- 覆盖层：绝对定位区域，由使用者提供 -->
        <div class="cosy:absolute cosy:inset-0">
          <slot name="overlay" />
        </div>

        <!-- 文字层：按行高对齐排版 -->
        <div
          class="cosy:relative cosy:h-full cosy:w-full cosy:whitespace-pre-wrap cosy:break-words cosy:text-gray-900"
          style="line-height: 1.7; font-size: 18px; font-weight: 500;">
          <slot />
        </div>
      </div>
    </div>
  </div>
</Container>
