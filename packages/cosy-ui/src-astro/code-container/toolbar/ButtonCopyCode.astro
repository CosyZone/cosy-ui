---



import Button from '../../button/Button.astro';
import { ClipboardIcon } from '../../icons/index';
import Toast from '../components/Toast.astro';
---

<div style="position: relative; display: inline-block;">
    <Button
        variant="ghost"
        size="sm"
        aria-label="复制代码"
        id="cosy-copy-btn"
        type="button">
        <ClipboardIcon />
    </Button>
    <Toast id="copy-toast" message="复制成功" />
</div>

<script>
    function initializeCopyCode() {
        const copyButtons = document.querySelectorAll(
            '[aria-label="复制代码"]'
        );
        copyButtons.forEach((button) => {
            button.addEventListener('click', () => {
                const container = button.closest(
                    '[data-role="code-container"]'
                );
                if (!container) return;

                // 获取当前激活的标签
                const activeTab = container.querySelector(
                    '[role="tab"].cosy\\:tab-active'
                );
                const activeTabId = activeTab
                    ? activeTab.getAttribute('data-tab')
                    : 'tab-1';

                // 根据 activeTabId 查找对应的代码面板
                const codePanel = container.querySelector(
                    `[data-code-panel="${activeTabId}"]`
                );
                if (!codePanel) return;

                const codeElement = codePanel.querySelector('code');
                if (!codeElement) return;

                const code = codeElement.textContent || '';
                navigator.clipboard.writeText(code).then(() => {
                    // 气泡提示 - Toast 在 button 的父元素中
                    const toastContainer = button.parentElement;
                    if (!toastContainer) return;

                    const toast = toastContainer.querySelector('#copy-toast');
                    if (toast && toast instanceof HTMLElement) {
                        toast.style.display = 'block';
                        toast.style.opacity = '1';
                        setTimeout(() => {
                            toast.style.opacity = '0';
                            setTimeout(() => {
                                toast.style.display = 'none';
                            }, 200);
                        }, 2000);
                    }
                });
            });
        });
    }

    document.addEventListener('astro:page-load', () => {
        initializeCopyCode();
    });
</script>
