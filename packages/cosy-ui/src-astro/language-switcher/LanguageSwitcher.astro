---
/**
 * @component LanguageSwitcher
 *
 * @description
 * LanguageSwitcher 组件提供一个语言切换下拉菜单，适用于使用 [lang] 动态路由的多语言网站。
 * 
 * **URL 生成规则**：
 * - 为每个语言生成格式为 `/{locale}{path}` 的 URL
 * - 例如：`/zh-cn/manuals`、`/en/manuals`
 * - 根路径：`/zh-cn`、`/en`
 * 
 * **适用场景**：
 * ✅ 使用 Astro 动态路由 `src/pages/[lang]/xxx.astro`
 * ✅ 所有语言都需要 URL 前缀（包括默认语言）
 * 
 * **不适用场景**：
 * ❌ 使用标准 Astro i18n 路由（`prefixDefaultLocale: true` 且不使用 [lang] 路由）
 * ❌ 默认语言不需要前缀的情况（如 `/` 对应英文，`/zh-cn` 对应中文）
 * 
 * 如果您的项目不符合上述适用场景，请不要使用此组件，或自行实现语言切换逻辑。
 *
 * @props
 * - locales - 必填，支持的语言列表，如：['zh-cn', 'en']
 * - class - 自定义CSS类名
 * 
 * @example
 * ```astro
 * <LanguageSwitcher locales={['zh-cn', 'en']} />
 * ```
 */

import { cn } from '../../src/class';
import { ChevronDownIcon, GlobeIcon } from '../icons';
import { Link } from '../link';
import { ListItem } from '../list';
import {
    generateSwitcherLinks,
    type SwitcherLink,
} from './util';

interface Props {
    /**
     * 必填：支持的语言列表
     * 例如：['zh-cn', 'en']
     */
    locales: string[];

    /**
     * 自定义类名
     */
    class?: string;
}

const { locales, class: className = '' } = Astro.props;

// 验证必填参数
if (!locales || locales.length === 0) {
    throw new Error('LanguageSwitcher: locales prop is required and must not be empty');
}

if (!Astro.currentLocale) {
    throw new Error('LanguageSwitcher: Astro.currentLocale is not defined. Make sure i18n is configured.');
}

let links: SwitcherLink[] = [];

// 生成切换链接
try {
    links = generateSwitcherLinks(
        Astro.currentLocale,
        Astro.url.pathname,
        locales
    );
} catch (error) {
    console.error('LanguageSwitcher: Failed to generate links:', error);
    throw error;
}

// 使用 classBuilder 构建类名
const dropdownClass = cn()
    .add('cosy:dropdown', 'cosy:dropdown-end')
    .add(className || '')
    .build();

const buttonClass = cn()
    .add('cosy:btn', 'cosy:btn-ghost') // 保留：DaisyUI 组件类名
    .build();

const iconClass = cn()
    .w(4)
    .h(4)
    .mr(1)
    .build();

const spanClass = cn()
    .mr(1)
    .hidden()
    .add('cosy:sm:inline') // 保留：响应式类名
    .build();

const chevronClass = cn()
    .w(4)
    .h(4)
    .build();

const ulClass = cn()
    .z(1)
    .bg('base-100')
    .shadow()
    .p(2)
    .add('cosy:rounded-box', 'cosy:w-32', 'cosy:dropdown-content', 'cosy:menu') // 保留：DaisyUI 组件类名
    .build();
---

{
    links.length > 0 && (
        <div class={dropdownClass}>
            <div tabindex="0" role="button" class={buttonClass}>
                <GlobeIcon size="16px" class={iconClass} />
                <span class={spanClass}>
                    {links.find(l => l.locale === Astro.currentLocale)?.name}
                </span>
                <ChevronDownIcon size="16px" class={chevronClass} />
            </div>
            <ul
                tabindex="0"
                class={ulClass}>
                {links.map((link) => (
                    <ListItem>
                        <Link
                            href={link.url}
                            active={Astro.currentLocale === link.locale}>
                            {link.name}
                        </Link>
                    </ListItem>
                ))}
            </ul>
        </div>
    )
}
