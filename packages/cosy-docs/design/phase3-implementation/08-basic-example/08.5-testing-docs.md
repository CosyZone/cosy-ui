# æ­¥éª¤ 08.5ï¼šæµ‹è¯•å’Œæ–‡æ¡£

## ç›®æ ‡
å®Œæˆé¡¹ç›®çš„æµ‹è¯•å’Œæ–‡æ¡£ç¼–å†™ã€‚

## ä»»åŠ¡æ¸…å•
- [ ] åˆ›å»ºAPIæµ‹è¯•
- [ ] ç¼–å†™ä½¿ç”¨æ–‡æ¡£
- [ ] æ·»åŠ ç¤ºä¾‹è¯´æ˜

## æ‰§è¡Œæ­¥éª¤

### 1. åˆ›å»º README æ–‡æ¡£

**åˆ›å»ºæ–‡ä»¶**: `packages/cosy-framework-example/README.md`

```markdown
# Basic API Example

è¿™æ˜¯ä¸€ä¸ªä½¿ç”¨ Cosy Framework æ„å»ºçš„åŸºç¡€ API ç¤ºä¾‹é¡¹ç›®ï¼Œå±•ç¤ºäº†æ¡†æ¶çš„æ ¸å¿ƒåŠŸèƒ½ã€‚

## åŠŸèƒ½ç‰¹æ€§

- ğŸš€ åŸºäº TypeScript çš„ç°ä»£æ¡†æ¶
- ğŸ”§ ä¾èµ–æ³¨å…¥å®¹å™¨
- ğŸ›£ï¸ çµæ´»çš„è·¯ç”±ç³»ç»Ÿ
- ğŸ”’ ä¸­é—´ä»¶æ”¯æŒ
- âš™ï¸ é…ç½®ç®¡ç†
- ğŸ“ RESTful API è®¾è®¡
- ğŸ§ª å®Œæ•´çš„æµ‹è¯•è¦†ç›–

## é¡¹ç›®ç»“æ„

```
src/
â”œâ”€â”€ controllers/     # æ§åˆ¶å™¨ï¼ˆè£…é¥°å™¨é£æ ¼ï¼‰
â”œâ”€â”€ services/        # ä¸šåŠ¡é€»è¾‘æœåŠ¡
â”œâ”€â”€ middleware/      # è‡ªå®šä¹‰ä¸­é—´ä»¶
â”œâ”€â”€ types/          # TypeScript ç±»å‹å®šä¹‰
â”œâ”€â”€ app.ts          # åº”ç”¨é…ç½®
â””â”€â”€ server.ts       # æœåŠ¡å™¨å¯åŠ¨

config/             # é…ç½®æ–‡ä»¶
â”œâ”€â”€ app.json        # åŸºç¡€é…ç½®
â”œâ”€â”€ development.json # å¼€å‘ç¯å¢ƒé…ç½®
â””â”€â”€ production.json  # ç”Ÿäº§ç¯å¢ƒé…ç½®

tests/              # æµ‹è¯•æ–‡ä»¶
```

## å®‰è£…å’Œè¿è¡Œ

### 1. å®‰è£…ä¾èµ–

```bash
npm install
```

### 2. å¤åˆ¶ç¯å¢ƒå˜é‡

```bash
cp .env.example .env
```

### 3. å¼€å‘æ¨¡å¼è¿è¡Œ

```bash
npm run dev
```

### 4. æ„å»ºå’Œç”Ÿäº§è¿è¡Œ

```bash
npm run build
npm start
```

## API æ–‡æ¡£

### å¥åº·æ£€æŸ¥

```http
GET /health
```

è¿”å›åº”ç”¨å¥åº·çŠ¶æ€ã€‚

### ç”¨æˆ· API

#### è·å–æ‰€æœ‰ç”¨æˆ·

```http
GET /api/v1/users
```

#### è·å–å•ä¸ªç”¨æˆ·

```http
GET /api/v1/users/{id}
```

#### åˆ›å»ºç”¨æˆ·

```http
POST /api/v1/users
Content-Type: application/json

{
  "name": "John Doe",
  "email": "john@example.com"
}
```

#### æ›´æ–°ç”¨æˆ·

```http
PUT /api/v1/users/{id}
Content-Type: application/json

{
  "name": "John Smith",
  "email": "johnsmith@example.com"
}
```

#### åˆ é™¤ç”¨æˆ·

```http
DELETE /api/v1/users/{id}
```

### æ–‡ç«  APIï¼ˆéœ€è¦è®¤è¯ï¼‰

æ‰€æœ‰æ–‡ç«  API éœ€è¦åœ¨è¯·æ±‚å¤´ä¸­åŒ…å«è®¤è¯ä»¤ç‰Œï¼š

```
Authorization: Bearer valid-token
```

#### è·å–æ‰€æœ‰æ–‡ç« 

```http
GET /api/v1/posts
Authorization: Bearer valid-token
```

#### åˆ›å»ºæ–‡ç« 

```http
POST /api/v1/posts
Authorization: Bearer valid-token
Content-Type: application/json

{
  "title": "My First Post",
  "content": "This is the content of my first post."
}
```

## æµ‹è¯•

### è¿è¡Œå•å…ƒæµ‹è¯•

```bash
npm test
```

### è¿è¡Œ API é›†æˆæµ‹è¯•

```bash
npm run test:api
```

## ç¤ºä¾‹è¯·æ±‚

### ä½¿ç”¨ curl

```bash
# å¥åº·æ£€æŸ¥
curl http://localhost:3000/health

# è·å–ç”¨æˆ·åˆ—è¡¨
curl http://localhost:3000/api/v1/users

# åˆ›å»ºç”¨æˆ·
curl -X POST http://localhost:3000/api/v1/users \
  -H "Content-Type: application/json" \
  -d '{"name":"Alice","email":"alice@example.com"}'

# è·å–æ–‡ç« ï¼ˆéœ€è¦è®¤è¯ï¼‰
curl http://localhost:3000/api/v1/posts \
  -H "Authorization: Bearer valid-token"

# åˆ›å»ºæ–‡ç« ï¼ˆéœ€è¦è®¤è¯ï¼‰
curl -X POST http://localhost:3000/api/v1/posts \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer valid-token" \
  -d '{"title":"Hello World","content":"This is my first post"}'
```

## é…ç½®

åº”ç”¨é…ç½®é€šè¿‡ä»¥ä¸‹æ–¹å¼ç®¡ç†ï¼š

1. **é…ç½®æ–‡ä»¶**: `config/` ç›®å½•ä¸‹çš„ JSON æ–‡ä»¶
2. **ç¯å¢ƒå˜é‡**: é€šè¿‡ `.env` æ–‡ä»¶æˆ–ç³»ç»Ÿç¯å¢ƒå˜é‡
3. **è¿è¡Œæ—¶é…ç½®**: é€šè¿‡ä»£ç åŠ¨æ€è®¾ç½®

### ç¯å¢ƒå˜é‡ä¼˜å…ˆçº§

ç¯å¢ƒå˜é‡ > ç¯å¢ƒç‰¹å®šé…ç½®æ–‡ä»¶ > åŸºç¡€é…ç½®æ–‡ä»¶ > é»˜è®¤å€¼

## æ‰©å±•åŠŸèƒ½

è¿™ä¸ªç¤ºä¾‹å±•ç¤ºäº† Cosy Framework çš„åŸºç¡€åŠŸèƒ½ã€‚ä½ å¯ä»¥åŸºäºæ­¤ç¤ºä¾‹æ·»åŠ ï¼š

- æ•°æ®åº“é›†æˆï¼ˆPostgreSQLã€MySQLã€MongoDBï¼‰
- è®¤è¯å’Œæˆæƒï¼ˆJWTã€OAuthï¼‰
- æ–‡ä»¶ä¸Šä¼ å¤„ç†
- ç¼“å­˜ï¼ˆRedisï¼‰
- ä»»åŠ¡é˜Ÿåˆ—
- WebSocket æ”¯æŒ
- é™æ€æ–‡ä»¶æœåŠ¡
- API æ–‡æ¡£ç”Ÿæˆ
- æ—¥å¿—ç®¡ç†
- ç›‘æ§å’ŒæŒ‡æ ‡

## è®¸å¯è¯

MIT License
```

### 2. åˆ›å»º API æµ‹è¯•

**åˆ›å»ºæ–‡ä»¶**: `packages/cosy-framework-example/tests/api.test.ts`

```typescript
import { describe, it, expect, beforeAll, afterAll } from 'vitest'
import { startServer } from '../src/server'
import { Application } from '@coffic/cosy-framework'
import { HttpContext, HttpStatus } from '@coffic/cosy-framework/http'

describe('Basic API Integration Tests', () => {
  let app: Application

  beforeAll(async () => {
    app = await startServer()
  })

  afterAll(async () => {
    if (app.isRunning()) {
      await app.stop()
    }
  })

  describe('Health Check', () => {
    it('should return health status', async () => {
      const context = HttpContext.create({ method: 'GET', url: '/health' })
      const response = await app.handle(context.request)

      expect(response.getStatus()).toBe(HttpStatus.OK)
      
      const body = JSON.parse(response.getContent())
      expect(body).toMatchObject({
        status: 'ok',
        timestamp: expect.any(String),
        uptime: expect.any(Number)
      })
    })
  })

  describe('User API', () => {
    it('should get all users', async () => {
      const context = HttpContext.create({ method: 'GET', url: '/api/v1/users' })
      const response = await app.handle(context.request)

      expect(response.getStatus()).toBe(HttpStatus.OK)
      
      const body = JSON.parse(response.getContent())
      expect(body).toMatchObject({
        users: expect.any(Array),
        total: expect.any(Number)
      })
      expect(body.users.length).toBeGreaterThan(0)
    })

    it('should get user by id', async () => {
      const context = HttpContext.create({ method: 'GET', url: '/api/v1/users/1' })
      const response = await app.handle(context.request)

      expect(response.getStatus()).toBe(HttpStatus.OK)
      
      const body = JSON.parse(response.getContent())
      expect(body).toMatchObject({
        user: {
          id: 1,
          name: expect.any(String),
          email: expect.any(String),
          createdAt: expect.any(String)
        }
      })
    })

    it('should create new user', async () => {
      const userData = {
        name: 'Test User',
        email: 'test@example.com'
      }

      const context = HttpContext.create({
        method: 'POST',
        url: '/api/v1/users',
        body: userData
      })
      const response = await app.handle(context.request)

      expect(response.getStatus()).toBe(HttpStatus.OK)
      
      const body = JSON.parse(response.getContent())
      expect(body).toMatchObject({
        user: {
          id: expect.any(Number),
          name: userData.name,
          email: userData.email,
          createdAt: expect.any(String)
        },
        message: 'User created successfully'
      })
    })
  })

  describe('Post API (Authenticated)', () => {
    it('should require authentication', async () => {
      const context = HttpContext.create({ method: 'GET', url: '/api/v1/posts' })
      const response = await app.handle(context.request)

      expect(response.getStatus()).toBe(HttpStatus.UNAUTHORIZED)
      
      const body = JSON.parse(response.getContent())
      expect(body.error).toContain('Authorization header required')
    })

    it('should get posts with valid token', async () => {
      const context = HttpContext.create({
        method: 'GET',
        url: '/api/v1/posts',
        headers: {
          authorization: 'Bearer valid-token'
        }
      })
      const response = await app.handle(context.request)

      expect(response.getStatus()).toBe(HttpStatus.OK)
      
      const body = JSON.parse(response.getContent())
      expect(body).toMatchObject({
        posts: expect.any(Array),
        total: expect.any(Number)
      })
    })

    it('should create post with valid token', async () => {
      const postData = {
        title: 'Test Post',
        content: 'This is a test post content.'
      }

      const context = HttpContext.create({
        method: 'POST',
        url: '/api/v1/posts',
        headers: {
          authorization: 'Bearer valid-token'
        },
        body: postData
      })
      const response = await app.handle(context.request)

      expect(response.getStatus()).toBe(HttpStatus.OK)
      
      const body = JSON.parse(response.getContent())
      expect(body).toMatchObject({
        post: {
          id: expect.any(Number),
          title: postData.title,
          content: postData.content,
          authorId: expect.any(Number),
          createdAt: expect.any(String)
        },
        message: 'Post created successfully'
      })
    })
  })
})
```

### 3. åˆ›å»º API æ–‡æ¡£

**åˆ›å»ºæ–‡ä»¶**: `packages/cosy-framework-example/docs/api.md`

```markdown
# API æ–‡æ¡£

## æ¦‚è¿°

è¿™æ˜¯ Cosy Framework Basic API Example çš„ API æ–‡æ¡£ã€‚æ‰€æœ‰ API éƒ½éµå¾ª RESTful è®¾è®¡åŸåˆ™ã€‚

## åŸºç¡€ä¿¡æ¯

- åŸºç¡€ URL: `http://localhost:3000`
- API ç‰ˆæœ¬: v1
- API å‰ç¼€: `/api/v1`

## è®¤è¯

éƒ¨åˆ† API éœ€è¦è®¤è¯ã€‚è®¤è¯é€šè¿‡ Bearer Token å®ç°ï¼š

```http
Authorization: Bearer valid-token
```

## å“åº”æ ¼å¼

æ‰€æœ‰å“åº”éƒ½ä½¿ç”¨ JSON æ ¼å¼ï¼ŒåŒ…å«ä»¥ä¸‹å­—æ®µï¼š

- æˆåŠŸå“åº”ï¼š
  ```json
  {
    "data": {}, // å“åº”æ•°æ®
    "message": "æ“ä½œæˆåŠŸ" // å¯é€‰çš„æˆåŠŸæ¶ˆæ¯
  }
  ```

- é”™è¯¯å“åº”ï¼š
  ```json
  {
    "error": "é”™è¯¯ä¿¡æ¯",
    "stack": "é”™è¯¯å †æ ˆï¼ˆä»…åœ¨å¼€å‘æ¨¡å¼ï¼‰"
  }
  ```

## API ç«¯ç‚¹

### å¥åº·æ£€æŸ¥

#### GET /health

æ£€æŸ¥åº”ç”¨ç¨‹åºçš„å¥åº·çŠ¶æ€ã€‚

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "status": "ok",
  "timestamp": "2024-01-01T00:00:00.000Z",
  "uptime": 123.456
}
```

### ç”¨æˆ·ç®¡ç†

#### GET /api/v1/users

è·å–æ‰€æœ‰ç”¨æˆ·åˆ—è¡¨ã€‚

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "users": [
    {
      "id": 1,
      "name": "John Doe",
      "email": "john@example.com",
      "createdAt": "2024-01-01T00:00:00.000Z"
    }
  ],
  "total": 1
}
```

#### GET /api/v1/users/{id}

è·å–æŒ‡å®šç”¨æˆ·ä¿¡æ¯ã€‚

**å‚æ•°**ï¼š
- `id`: ç”¨æˆ·IDï¼ˆè·¯å¾„å‚æ•°ï¼‰

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "user": {
    "id": 1,
    "name": "John Doe",
    "email": "john@example.com",
    "createdAt": "2024-01-01T00:00:00.000Z"
  }
}
```

#### POST /api/v1/users

åˆ›å»ºæ–°ç”¨æˆ·ã€‚

**è¯·æ±‚ä½“**ï¼š
```json
{
  "name": "John Doe",
  "email": "john@example.com"
}
```

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "user": {
    "id": 1,
    "name": "John Doe",
    "email": "john@example.com",
    "createdAt": "2024-01-01T00:00:00.000Z"
  },
  "message": "User created successfully"
}
```

### æ–‡ç« ç®¡ç†

> éœ€è¦è®¤è¯

#### GET /api/v1/posts

è·å–æ‰€æœ‰æ–‡ç« åˆ—è¡¨ã€‚

**è¯·æ±‚å¤´**ï¼š
```http
Authorization: Bearer valid-token
```

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "posts": [
    {
      "id": 1,
      "title": "Hello World",
      "content": "This is my first post",
      "authorId": 1,
      "createdAt": "2024-01-01T00:00:00.000Z"
    }
  ],
  "total": 1
}
```

#### POST /api/v1/posts

åˆ›å»ºæ–°æ–‡ç« ã€‚

**è¯·æ±‚å¤´**ï¼š
```http
Authorization: Bearer valid-token
Content-Type: application/json
```

**è¯·æ±‚ä½“**ï¼š
```json
{
  "title": "My First Post",
  "content": "This is the content of my first post."
}
```

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "post": {
    "id": 1,
    "title": "My First Post",
    "content": "This is the content of my first post.",
    "authorId": 1,
    "createdAt": "2024-01-01T00:00:00.000Z"
  },
  "message": "Post created successfully"
}
```

## é”™è¯¯å¤„ç†

### å¸¸è§é”™è¯¯ç 

- 400 Bad Request: è¯·æ±‚å‚æ•°é”™è¯¯
- 401 Unauthorized: æœªè®¤è¯æˆ–è®¤è¯å¤±è´¥
- 403 Forbidden: æƒé™ä¸è¶³
- 404 Not Found: èµ„æºä¸å­˜åœ¨
- 500 Internal Server Error: æœåŠ¡å™¨å†…éƒ¨é”™è¯¯

### é”™è¯¯å“åº”ç¤ºä¾‹

```json
{
  "error": "User not found",
  "stack": "Error: User not found\n    at UserService.getUserById ..."
}
```

## æœ€ä½³å®è·µ

1. å§‹ç»ˆä½¿ç”¨ HTTPS åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä¼ è¾“æ•°æ®
2. åˆç†ä½¿ç”¨ HTTP æ–¹æ³•ï¼š
   - GET: è·å–èµ„æº
   - POST: åˆ›å»ºèµ„æº
   - PUT: æ›´æ–°èµ„æº
   - DELETE: åˆ é™¤èµ„æº
3. æ­£ç¡®å¤„ç†é”™è¯¯å“åº”
4. ä½¿ç”¨åˆé€‚çš„ HTTP çŠ¶æ€ç 
5. éµå¾ª RESTful å‘½åçº¦å®š
```

## å®Œæˆæ ‡å¿—
- [ ] APIæµ‹è¯•å·²å®Œæˆ
- [ ] ä½¿ç”¨æ–‡æ¡£å·²å®Œæˆ
- [ ] ç¤ºä¾‹è¯´æ˜å·²å®Œæˆ
- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡
- [ ] æ–‡æ¡£æ ¼å¼æ­£ç¡®

## ä¸‹ä¸€æ­¥
å®Œæˆæ­¤æ­¥éª¤åï¼ŒåŸºç¡€ç¤ºä¾‹é¡¹ç›®å°±å®Œæˆäº†ï¼ä½ å¯ä»¥ï¼š

1. ç»§ç»­æ·»åŠ æ›´å¤šåŠŸèƒ½ï¼ˆæ•°æ®åº“ã€è®¤è¯ã€æ–‡ä»¶ä¸Šä¼ ç­‰ï¼‰
2. ä¼˜åŒ–æ€§èƒ½å’Œé”™è¯¯å¤„ç†
3. æ·»åŠ æ›´å¤šä¸­é—´ä»¶å’Œå·¥å…·
4. åˆ›å»ºæ›´å¤šç¤ºä¾‹é¡¹ç›®
5. ç¼–å†™è¯¦ç»†çš„ä½¿ç”¨æ–‡æ¡£ 
