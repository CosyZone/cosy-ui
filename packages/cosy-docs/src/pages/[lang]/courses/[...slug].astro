---
import BaseLayout from '@/layouts/BaseLayout.astro';
import { Error404, type ISidebarItem, Link, ListItem } from '@coffic/cosy-ui';
import { courseRepo } from '@coffic/cosy-content';
import type { CourseDoc } from '@coffic/cosy-content';
import type { RenderResult } from 'astro:content';

const { lang, slug } = Astro.params;
const doc = await courseRepo.find(`${lang}/${slug}`);
let title = '';
let renderResult: RenderResult | null = null;
let sidebarItems: ISidebarItem | null = null;
let courseDescription = '';
let childrenDocs: CourseDoc[] = [];

if (doc) {
  title = doc.getTitle();
  renderResult = await doc.render();

  // 获取顶级文档
  const topDoc = await doc.getAncestor(1);
  if (topDoc) {
    sidebarItems = await topDoc.toSidebarItem();
    courseDescription = doc.getDescription();
    childrenDocs = await doc.getChildren();
  }
} else {
  title = '404 Not Found';
}

export const getStaticPaths = async () => {
  const paths = await courseRepo.getStaticPaths();

  // 过滤掉 slug 为空的路径
  return paths.filter((path) => {
    const slug = path.params.slug;
    return slug && slug.length > 0;
  });
};
---

<BaseLayout title={title} sidebarItems={sidebarItems}>
  {
    renderResult ? (
      <>
        <h1>{title}</h1>

        {courseDescription && (
          <>
            <h2>简介</h2>
            <p>{courseDescription}</p>
          </>
        )}

        <renderResult.Content />

        {childrenDocs.length > 0 && (
                    <h2>目录</h2>
                    <ul>
                        {childrenDocs.map(child => (
                            <ListItem>
                                <Link href={`${child.getLink()}`} class="no-underline">
                                    {child.getTitle()}
                                </Link>
                            </ListItem>
                        ))}
                    </ul>
                )}
      </>
    ) : (
      <Error404 debugKVs={{ slug }} />
    )
  }
</BaseLayout>
