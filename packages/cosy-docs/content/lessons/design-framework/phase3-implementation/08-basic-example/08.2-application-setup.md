# æ­¥éª¤ 08.2ï¼šåº”ç”¨æ ¸å¿ƒå®ç°

## ç›®æ ‡
å®ç°åº”ç”¨ç¨‹åºçš„æ ¸å¿ƒåŠŸèƒ½ï¼ŒåŒ…æ‹¬åº”ç”¨é…ç½®ã€æœåŠ¡å™¨å¯åŠ¨å’Œé”™è¯¯å¤„ç†ã€‚

## ä»»åŠ¡æ¸…å•
- [ ] å®ç°åº”ç”¨å…¥å£æ–‡ä»¶
- [ ] å®ç°æœåŠ¡å™¨å¯åŠ¨æ–‡ä»¶
- [ ] é…ç½®åº”ç”¨å®ä¾‹

## æ‰§è¡Œæ­¥éª¤

### 1. åˆ›å»ºåº”ç”¨å…¥å£æ–‡ä»¶

**åˆ›å»ºæ–‡ä»¶**: `packages/cosy-framework-example/src/app.ts`

```typescript
import { 
    Application, 
    gracefulShutdown, 
    setupErrorHandling,
    cors,
    logger,
    errorHandler,
    type HttpContextInterface
} from '@coffic/cosy-framework'
import { UserController } from './controllers/user-controller'
import { PostController } from './controllers/post-controller'
import { AuthMiddleware } from './middleware/auth-middleware'
import { UserService } from './services/user-service'
import { PostService } from './services/post-service'

// åˆ›å»ºåº”ç”¨å®ä¾‹
console.log("ğŸš€ğŸš€ åˆ›å»ºåº”ç”¨å®ä¾‹")
const app = Application.create({
    name: 'Basic API Example',
    debug: process.env.NODE_ENV !== 'production',
    port: parseInt(process.env.PORT || '3000')
})

// æ³¨å†ŒæœåŠ¡
app.bind('UserService', UserService)
app.bind('PostService', PostService)

// æ³¨å†Œä¸­é—´ä»¶
app.middleware('auth', AuthMiddleware)

// å…¨å±€ä¸­é—´ä»¶
app.use(cors({
    origin: process.env.CORS_ORIGIN || '*',
    credentials: true
}))

app.use(logger({
    skip: (context: HttpContextInterface) => context.request.path === '/health'
}))

app.use(errorHandler({
    showStack: app.config('app.debug')
}))

// å¥åº·æ£€æŸ¥è·¯ç”±
app.get('/health', () => ({
    status: 'ok',
    timestamp: new Date().toISOString(),
    uptime: process.uptime()
}))

// API è·¯ç”±
app.group('/api/v1', (api) => {
    // ç”¨æˆ·è·¯ç”±
    api.group('/users', (users) => {
        users.get('/', (context) => {
            const userService = app.resolve<UserService>('UserService')
            return userService.getUsers()
        })

        users.get('/{id}', (context) => {
            const userService = app.resolve<UserService>('UserService')
            const id = parseInt(context.request.params.id)
            return userService.getUserById(id)
        })

        users.post('/', (context) => {
            const userService = app.resolve<UserService>('UserService')
            const userData = context.request.body
            return userService.createUser(userData)
        })

        users.put('/{id}', (context) => {
            const userService = app.resolve<UserService>('UserService')
            const id = parseInt(context.request.params.id)
            const userData = context.request.body
            return userService.updateUser(id, userData)
        })

        users.delete('/{id}', (context) => {
            const userService = app.resolve<UserService>('UserService')
            const id = parseInt(context.request.params.id)
            return userService.deleteUser(id)
        })
    })

    // éœ€è¦è®¤è¯çš„è·¯ç”±
    api.group({ prefix: '/posts', middleware: AuthMiddleware }, (posts) => {
        posts.get('/', (context) => {
            const postService = app.resolve<PostService>('PostService')
            return postService.getPosts()
        })

        posts.post('/', (context) => {
            const postService = app.resolve<PostService>('PostService')
            const postData = context.request.body
            const userId = (context as any).user?.id
            return postService.createPost(postData, userId)
        })
    })
})

// é”™è¯¯å¤„ç†
setupErrorHandling(app)

// ä¼˜é›…å…³é—­
gracefulShutdown(app)

// å¯¼å‡ºåº”ç”¨å®ä¾‹ä¾› server.ts ä½¿ç”¨
export { app }
```

### 2. åˆ›å»ºæœåŠ¡å™¨å¯åŠ¨æ–‡ä»¶

**åˆ›å»ºæ–‡ä»¶**: `packages/cosy-framework-example/src/server.ts`

```typescript
/**
 * @file server.ts
 * @description æœåŠ¡å™¨å¯åŠ¨å…¥å£æ–‡ä»¶ï¼Œè´Ÿè´£å¼•å¯¼åº”ç”¨ç¨‹åºçš„å¯åŠ¨è¿‡ç¨‹
 * 
 * è¯¥æ–‡ä»¶ä¸»è¦èŒè´£ï¼š
 * 1. å¯åŠ¨åº”ç”¨ç¨‹åº
 * 2. å¤„ç†å¯åŠ¨è¿‡ç¨‹ä¸­çš„é”™è¯¯
 */

import { app } from './app'

/**
 * å¯åŠ¨æœåŠ¡å™¨çš„ä¸»å‡½æ•°
 * @description è´Ÿè´£å¯åŠ¨åº”ç”¨ç¨‹åºå¹¶å¤„ç†å¯åŠ¨è¿‡ç¨‹ä¸­çš„é”™è¯¯
 * @returns {Promise<Application>} è¿”å›å¯åŠ¨æˆåŠŸçš„åº”ç”¨å®ä¾‹ï¼Œä¸»è¦ç”¨äºæµ‹è¯•ç›®çš„
 * @throws {Error} å½“æœåŠ¡å™¨å¯åŠ¨å¤±è´¥æ—¶æŠ›å‡ºé”™è¯¯
 */
async function startServer() {
    try {
        console.log('ğŸ”„ æ­£åœ¨å¯åŠ¨æœåŠ¡å™¨...')
        
        await app.boot()
        await app.start()
        
        console.log('âœ… æœåŠ¡å™¨å¯åŠ¨æˆåŠŸ!')
        console.log('ğŸ¥ å¥åº·æ£€æŸ¥: http://localhost:3000/health')
        
        return app
    } catch (error) {
        console.error('âŒ æœåŠ¡å™¨å¯åŠ¨å¤±è´¥:', error)
        process.exit(1)
    }
}

// å¦‚æœç›´æ¥è¿è¡Œæ­¤æ–‡ä»¶ï¼Œå¯åŠ¨æœåŠ¡å™¨
if (require.main === module) {
    startServer()
}

export { startServer }
```

### 3. åˆ›å»ºé…ç½®æ–‡ä»¶

#### 3.1 åŸºç¡€é…ç½®

**åˆ›å»ºæ–‡ä»¶**: `packages/cosy-framework-example/config/app.json`

```json
{
  "app": {
    "name": "Basic API Example",
    "version": "1.0.0",
    "debug": false,
    "port": 3000,
    "host": "0.0.0.0"
  },
  "cors": {
    "origin": "*",
    "credentials": true,
    "methods": ["GET", "POST", "PUT", "DELETE", "OPTIONS"],
    "allowedHeaders": ["Content-Type", "Authorization"]
  },
  "logging": {
    "level": "info",
    "format": "combined"
  }
}
```

#### 3.2 å¼€å‘ç¯å¢ƒé…ç½®

**åˆ›å»ºæ–‡ä»¶**: `packages/cosy-framework-example/config/development.json`

```json
{
  "app": {
    "debug": true,
    "port": 3000
  },
  "logging": {
    "level": "debug"
  }
}
```

#### 3.3 ç”Ÿäº§ç¯å¢ƒé…ç½®

**åˆ›å»ºæ–‡ä»¶**: `packages/cosy-framework-example/config/production.json`

```json
{
  "app": {
    "debug": false,
    "port": 8080
  },
  "cors": {
    "origin": ["https://yourdomain.com"],
    "credentials": true
  },
  "logging": {
    "level": "warn"
  }
}
```

### 4. åˆ›å»ºå¯åŠ¨è„šæœ¬

#### 4.1 ç”Ÿäº§ç¯å¢ƒå¯åŠ¨è„šæœ¬

**åˆ›å»ºæ–‡ä»¶**: `packages/cosy-framework-example/scripts/start.sh`

```bash
#!/bin/bash

# Basic API Example å¯åŠ¨è„šæœ¬

echo "ğŸš€ å¯åŠ¨ Cosy Framework Basic API Example"

# æ£€æŸ¥ Node.js ç‰ˆæœ¬
NODE_VERSION=$(node -v)
echo "Node.js ç‰ˆæœ¬: $NODE_VERSION"

# è®¾ç½®ç¯å¢ƒå˜é‡
export NODE_ENV=${NODE_ENV:-development}
echo "ç¯å¢ƒ: $NODE_ENV"

# æ„å»ºé¡¹ç›®
echo "ğŸ“¦ æ„å»ºé¡¹ç›®..."
npm run build

# å¯åŠ¨åº”ç”¨
echo "ğŸŒŸ å¯åŠ¨åº”ç”¨..."
npm start
```

#### 4.2 å¼€å‘ç¯å¢ƒå¯åŠ¨è„šæœ¬

**åˆ›å»ºæ–‡ä»¶**: `packages/cosy-framework-example/scripts/dev.sh`

```bash
#!/bin/bash

# å¼€å‘æ¨¡å¼å¯åŠ¨è„šæœ¬

echo "ğŸ”§ å¯åŠ¨å¼€å‘æ¨¡å¼"

# è®¾ç½®å¼€å‘ç¯å¢ƒ
export NODE_ENV=development
export APP_DEBUG=true

# å¯åŠ¨å¼€å‘æœåŠ¡å™¨
npm run dev
```

ä½¿è„šæœ¬å¯æ‰§è¡Œï¼š
```bash
chmod +x packages/cosy-framework-example/scripts/*.sh
```

## å®Œæˆæ ‡å¿—
- [ ] åº”ç”¨å…¥å£æ–‡ä»¶å·²å®ç°
- [ ] æœåŠ¡å™¨å¯åŠ¨æ–‡ä»¶å·²å®ç°
- [ ] é…ç½®æ–‡ä»¶å·²åˆ›å»º
- [ ] å¯åŠ¨è„šæœ¬å·²åˆ›å»º
- [ ] æ‰€æœ‰æ–‡ä»¶å¯ä»¥æ­£å¸¸è¿è¡Œ

## ä¸‹ä¸€æ­¥
å®Œæˆæ­¤æ­¥éª¤åï¼Œç»§ç»­æ‰§è¡Œ [08.3-api-implementation.md](./08.3-api-implementation.md)ã€‚ 
