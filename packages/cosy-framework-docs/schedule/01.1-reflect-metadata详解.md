# é™„ä»¶ 01.1ï¼šreflect-metadata è¯¦è§£

> æœ¬æ–‡æ¡£æ˜¯æ­¥éª¤ 01 çš„è¡¥å……ææ–™ï¼Œæ·±å…¥è®²è§£ `reflect-metadata` çš„æ ¸å¿ƒæ¦‚å¿µå’Œåœ¨ Cosy Framework ä¸­çš„é‡è¦ä½œç”¨ã€‚
> 
> **æ–‡ä»¶å‘½åè§„åˆ™**: 
> - ä¸»æ­¥éª¤ï¼š`01-xxx.md`ã€`02-xxx.md`ã€...
> - é™„ä»¶æ–‡æ¡£ï¼š`01.1-xxx.md`ã€`01.2-xxx.md`ã€`02.1-xxx.md`ã€...

## ğŸ“š ç›®å½•
- [ä»€ä¹ˆæ˜¯ reflect-metadata](#ä»€ä¹ˆæ˜¯-reflect-metadata)
- [ä¸ºä»€ä¹ˆéœ€è¦å®ƒ](#ä¸ºä»€ä¹ˆéœ€è¦å®ƒ)
- [æ ¸å¿ƒ API ä»‹ç»](#æ ¸å¿ƒ-api-ä»‹ç»)
- [åœ¨ä¾èµ–æ³¨å…¥ä¸­çš„åº”ç”¨](#åœ¨ä¾èµ–æ³¨å…¥ä¸­çš„åº”ç”¨)
- [è£…é¥°å™¨ä¸å…ƒæ•°æ®çš„ç»“åˆ](#è£…é¥°å™¨ä¸å…ƒæ•°æ®çš„ç»“åˆ)
- [å®é™…ä»£ç æ¼”ç¤º](#å®é™…ä»£ç æ¼”ç¤º)
- [å¸¸è§é—®é¢˜è§£ç­”](#å¸¸è§é—®é¢˜è§£ç­”)

## ğŸ¯ å¯è¿è¡Œæ¼”ç¤º

æˆ‘ä»¬åœ¨ `examples/` ç›®å½•ä¸­æä¾›äº†ä¸¤ä¸ªæ¼”ç¤ºæ–‡ä»¶ï¼š

1. **[reflect-metadata-simple.ts](../examples/reflect-metadata-simple.ts)** - ç®€åŒ–ç‰ˆæ¼”ç¤ºï¼Œä¸“æ³¨äºæ ¸å¿ƒæ¦‚å¿µ
2. **[reflect-metadata-demo.ts](../examples/reflect-metadata-demo.ts)** - å®Œæ•´ç‰ˆæ¼”ç¤ºï¼ŒåŒ…å«è£…é¥°å™¨è¯­æ³•

è¿è¡Œæ¼”ç¤ºï¼š
```bash
cd packages/cosy-framework-docs
npx tsx examples/reflect-metadata-simple.ts
```

## ä»€ä¹ˆæ˜¯ reflect-metadata

`reflect-metadata` æ˜¯ä¸€ä¸ª **JavaScript/TypeScript åå°„åº“**ï¼Œå®ƒæ‰©å±•äº†åŸç”Ÿçš„ `Reflect` APIï¼Œæä¾›äº†åœ¨è¿è¡Œæ—¶å­˜å‚¨å’Œæ£€ç´¢å…ƒæ•°æ®çš„èƒ½åŠ›ã€‚

### æ ¸å¿ƒæ¦‚å¿µ

```typescript
// å…ƒæ•°æ®å°±æ˜¯"æ•°æ®çš„æ•°æ®"
// æ¯”å¦‚ï¼šç±»å‹ä¿¡æ¯ã€è£…é¥°å™¨é…ç½®ã€ä¾èµ–å…³ç³»ç­‰

class User {
  @Column({ type: 'varchar', length: 255 })  // è¿™æ˜¯å…ƒæ•°æ®
  name: string;                               // è¿™æ˜¯æ•°æ®
}
```

## ä¸ºä»€ä¹ˆéœ€è¦å®ƒ

### 1. TypeScript ç±»å‹æ“¦é™¤é—®é¢˜

TypeScript ç¼–è¯‘åï¼Œæ‰€æœ‰ç±»å‹ä¿¡æ¯éƒ½ä¼šä¸¢å¤±ï¼š

```typescript
// TypeScript æºç 
class UserService {
  constructor(private database: DatabaseService) {}
}

// ç¼–è¯‘åçš„ JavaScript
class UserService {
  constructor(database) {  // ç±»å‹ä¿¡æ¯ä¸¢å¤±ï¼
    this.database = database;
  }
}
```

### 2. ä¾èµ–æ³¨å…¥éœ€è¦ç±»å‹ä¿¡æ¯

IoC å®¹å™¨éœ€è¦çŸ¥é“ï¼š
- è¿™ä¸ªç±»éœ€è¦å“ªäº›ä¾èµ–ï¼Ÿ
- æ¯ä¸ªä¾èµ–çš„ç±»å‹æ˜¯ä»€ä¹ˆï¼Ÿ
- å¦‚ä½•åˆ›å»ºå’Œæ³¨å…¥è¿™äº›ä¾èµ–ï¼Ÿ

```typescript
// å®¹å™¨éœ€è¦å›ç­”è¿™äº›é—®é¢˜ï¼š
class UserService {
  constructor(database: ???) {}  // éœ€è¦ä»€ä¹ˆç±»å‹ï¼Ÿ
  //          ^^^^^^^^ 
  //          reflect-metadata æä¾›ç­”æ¡ˆ
}
```

## æ ¸å¿ƒ API ä»‹ç»

### 1. åŸºç¡€å…ƒæ•°æ®æ“ä½œ

```typescript
import 'reflect-metadata';

// å®šä¹‰å…ƒæ•°æ®
Reflect.defineMetadata(key, value, target, propertyKey?);

// è·å–å…ƒæ•°æ®
Reflect.getMetadata(key, target, propertyKey?);

// æ£€æŸ¥æ˜¯å¦å­˜åœ¨
Reflect.hasMetadata(key, target, propertyKey?);

// åˆ é™¤å…ƒæ•°æ®
Reflect.deleteMetadata(key, target, propertyKey?);
```

### 2. è‡ªåŠ¨ç”Ÿæˆçš„è®¾è®¡æ—¶å…ƒæ•°æ®

å½“å¯ç”¨ `emitDecoratorMetadata: true` æ—¶ï¼ŒTypeScript ä¼šè‡ªåŠ¨ç”Ÿæˆï¼š

```typescript
// è‡ªåŠ¨ç”Ÿæˆçš„å…ƒæ•°æ®é”®
'design:type'        // å±æ€§ç±»å‹
'design:paramtypes'  // æ„é€ å‡½æ•°å‚æ•°ç±»å‹
'design:returntype'  // æ–¹æ³•è¿”å›ç±»å‹
```

## åœ¨ä¾èµ–æ³¨å…¥ä¸­çš„åº”ç”¨

### 1. è‡ªåŠ¨ä¾èµ–å‘ç°

```typescript
class DatabaseService {
  connect() { console.log('Connected to database'); }
}

class UserService {
  // TypeScript è‡ªåŠ¨ç”Ÿæˆ: 
  // Reflect.defineMetadata('design:paramtypes', [DatabaseService], UserService);
  constructor(private db: DatabaseService) {}
}

// å®¹å™¨å¯ä»¥è‡ªåŠ¨å‘ç°ä¾èµ–
const paramTypes = Reflect.getMetadata('design:paramtypes', UserService);
console.log(paramTypes); // [DatabaseService]
```

### 2. ç®€å•çš„ IoC å®¹å™¨å®ç°

```typescript
class SimpleContainer {
  private bindings = new Map();
  
  bind<T>(token: string, implementation: new (...args: any[]) => T) {
    this.bindings.set(token, implementation);
  }
  
  resolve<T>(token: string): T {
    const Implementation = this.bindings.get(token);
    
    // è·å–æ„é€ å‡½æ•°å‚æ•°ç±»å‹ï¼ˆå…³é”®æ­¥éª¤ï¼ï¼‰
    const paramTypes = Reflect.getMetadata('design:paramtypes', Implementation) || [];
    
    // é€’å½’è§£æä¾èµ–
    const dependencies = paramTypes.map(ParamType => {
      const dependencyToken = ParamType.name; // ç®€åŒ–ï¼šä½¿ç”¨ç±»åä½œä¸º token
      return this.resolve(dependencyToken);
    });
    
    // åˆ›å»ºå®ä¾‹å¹¶æ³¨å…¥ä¾èµ–
    return new Implementation(...dependencies);
  }
}
```

## è£…é¥°å™¨ä¸å…ƒæ•°æ®çš„ç»“åˆ

### 1. åˆ›å»ºè£…é¥°å™¨

```typescript
// Injectable è£…é¥°å™¨
function Injectable(target: any) {
  // æ ‡è®°ä¸ºå¯æ³¨å…¥
  Reflect.defineMetadata('injectable', true, target);
  
  // ä¿å­˜ä¾èµ–ä¿¡æ¯
  const paramTypes = Reflect.getMetadata('design:paramtypes', target) || [];
  Reflect.defineMetadata('dependencies', paramTypes, target);
}

// Inject è£…é¥°å™¨
function Inject(token: string) {
  return function (target: any, propertyKey: string | symbol | undefined, parameterIndex: number) {
    const existingTokens = Reflect.getMetadata('inject-tokens', target) || [];
    existingTokens[parameterIndex] = token;
    Reflect.defineMetadata('inject-tokens', existingTokens, target);
  };
}
```

### 2. ä½¿ç”¨è£…é¥°å™¨

```typescript
@Injectable
class UserService {
  constructor(
    @Inject('DatabaseService') private db: DatabaseService,
    @Inject('CacheService') private cache: CacheService
  ) {}
}

// å…ƒæ•°æ®è¢«è‡ªåŠ¨ä¿å­˜
const isInjectable = Reflect.getMetadata('injectable', UserService); // true
const dependencies = Reflect.getMetadata('dependencies', UserService); // [DatabaseService, CacheService]
const injectTokens = Reflect.getMetadata('inject-tokens', UserService); // ['DatabaseService', 'CacheService']
```

## å®é™…ä»£ç æ¼”ç¤º

è®©æˆ‘ä»¬è¿è¡Œä¸€ä¸ªå®Œæ•´çš„ç¤ºä¾‹ï¼š

```typescript
import 'reflect-metadata';

// 1. å®šä¹‰æœåŠ¡
class DatabaseService {
  connect() {
    return 'Database connected';
  }
}

class LoggerService {
  log(message: string) {
    console.log(`[LOG] ${message}`);
  }
}

class UserService {
  constructor(
    private db: DatabaseService,
    private logger: LoggerService
  ) {}
  
  getUsers() {
    const result = this.db.connect();
    this.logger.log('Getting users');
    return ['user1', 'user2'];
  }
}

// 2. é«˜çº§å®¹å™¨å®ç°
class Container {
  private bindings = new Map();
  private instances = new Map();
  
  bind<T>(token: string, implementation: new (...args: any[]) => T, singleton: boolean = false) {
    this.bindings.set(token, { implementation, singleton });
  }
  
  resolve<T>(token: string): T {
    // æ£€æŸ¥å•ä¾‹ç¼“å­˜
    if (this.instances.has(token)) {
      return this.instances.get(token);
    }
    
    const binding = this.bindings.get(token);
    if (!binding) {
      throw new Error(`No binding found for ${token}`);
    }
    
    const { implementation: Implementation, singleton } = binding;
    
    // è·å–ä¾èµ–ç±»å‹
    const paramTypes = Reflect.getMetadata('design:paramtypes', Implementation) || [];
    
    // è§£æä¾èµ–
    const dependencies = paramTypes.map((ParamType: any) => {
      return this.resolve(ParamType.name);
    });
    
    // åˆ›å»ºå®ä¾‹
    const instance = new Implementation(...dependencies);
    
    // ç¼“å­˜å•ä¾‹
    if (singleton) {
      this.instances.set(token, instance);
    }
    
    return instance;
  }
}

// 3. ä½¿ç”¨ç¤ºä¾‹
const container = new Container();

// æ³¨å†ŒæœåŠ¡
container.bind('DatabaseService', DatabaseService, true);  // å•ä¾‹
container.bind('LoggerService', LoggerService, true);      // å•ä¾‹
container.bind('UserService', UserService);               // æ¯æ¬¡åˆ›å»ºæ–°å®ä¾‹

// è§£ææœåŠ¡
const userService = container.resolve<UserService>('UserService');
console.log(userService.getUsers());

// éªŒè¯å•ä¾‹
const userService2 = container.resolve<UserService>('UserService');
const db1 = container.resolve<DatabaseService>('DatabaseService');
const db2 = container.resolve<DatabaseService>('DatabaseService');

console.log('ä¸åŒçš„ UserService å®ä¾‹:', userService !== userService2);  // true
console.log('ç›¸åŒçš„ Database å®ä¾‹:', db1 === db2);                     // true
```

## åœ¨ Cosy Framework ä¸­çš„åº”ç”¨é¢„è§ˆ

åœ¨æˆ‘ä»¬æ­£åœ¨å¼€å‘çš„æ¡†æ¶ä¸­ï¼Œ`reflect-metadata` å°†æ”¯æŒè¿™æ ·çš„è¯­æ³•ï¼š

```typescript
// æ§åˆ¶å™¨å®šä¹‰
@Controller('/api/users')
export class UserController {
  constructor(
    @Inject('UserService') private userService: UserService,
    @Inject('Logger') private logger: Logger
  ) {}
  
  @Get('/')
  @Middleware(authMiddleware)
  async index() {
    this.logger.log('Getting all users');
    return await this.userService.findAll();
  }
  
  @Post('/')
  @Validate(CreateUserDto)
  async create(@Body() userData: CreateUserDto) {
    return await this.userService.create(userData);
  }
}

// æœåŠ¡å®šä¹‰
@Injectable
export class UserService {
  constructor(
    @Inject('UserRepository') private userRepo: UserRepository,
    @Inject('EventDispatcher') private events: EventDispatcher
  ) {}
  
  async create(data: CreateUserDto) {
    const user = await this.userRepo.create(data);
    await this.events.dispatch('user.created', user);
    return user;
  }
}
```

## å¸¸è§é—®é¢˜è§£ç­”

### Q1: ä¸ºä»€ä¹ˆå¿…é¡»åœ¨æ–‡ä»¶æœ€å‰é¢å¯¼å…¥ï¼Ÿ

**A:** å› ä¸º `reflect-metadata` æ˜¯ä¸€ä¸ª polyfillï¼Œå®ƒæ‰©å±•äº†å…¨å±€çš„ `Reflect` å¯¹è±¡ã€‚TypeScript ç¼–è¯‘çš„è£…é¥°å™¨ä»£ç ä¼šç«‹å³ä½¿ç”¨è¿™äº› APIï¼Œæ‰€ä»¥å¿…é¡»åœ¨ä»»ä½•è£…é¥°å™¨ä»£ç æ‰§è¡Œå‰åŠ è½½ã€‚

### Q2: å¦‚æœå¿˜è®°å¯¼å…¥ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ

**A:** ä¼šå‡ºç°è¿è¡Œæ—¶é”™è¯¯ï¼š
```
TypeError: Reflect.getMetadata is not a function
```

### Q3: å®ƒå¯¹æ€§èƒ½æœ‰å½±å“å—ï¼Ÿ

**A:** 
- **ç¼–è¯‘æ—¶**ï¼šä¼šå¢åŠ ä¸€äº›ç¼–è¯‘åçš„ä»£ç ä½“ç§¯
- **è¿è¡Œæ—¶**ï¼šå…ƒæ•°æ®æŸ¥è¯¢æ˜¯å¿«é€Ÿçš„ï¼Œå½±å“å¾®ä¹å…¶å¾®
- **å†…å­˜**ï¼šä¼šå­˜å‚¨ä¸€äº›é¢å¤–çš„å…ƒæ•°æ®ï¼Œä½†é€šå¸¸å¾ˆå°

### Q4: å¯ä»¥åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨å—ï¼Ÿ

**A:** æ˜¯çš„ï¼Œè®¸å¤šçŸ¥åæ¡†æ¶éƒ½åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ï¼š
- Angular
- NestJS  
- TypeORM
- InversifyJS

### Q5: æœ‰æ›¿ä»£æ–¹æ¡ˆå—ï¼Ÿ

**A:** 
- **æ‰‹åŠ¨æ³¨å†Œ**ï¼šæ‰‹åŠ¨æŒ‡å®šä¾èµ–å…³ç³»ï¼ˆå¤±å»è‡ªåŠ¨åŒ–ï¼‰
- **ä»£ç ç”Ÿæˆ**ï¼šç¼–è¯‘æ—¶ç”Ÿæˆä¾èµ–ä¿¡æ¯ï¼ˆå¢åŠ å¤æ‚æ€§ï¼‰
- **è¿è¡Œæ—¶åˆ†æ**ï¼šåˆ†ææºç å­—ç¬¦ä¸²ï¼ˆæ€§èƒ½å·®ï¼Œä¸å¯é ï¼‰

## æ€»ç»“

`reflect-metadata` æ˜¯ç°ä»£ TypeScript æ¡†æ¶çš„æ ¸å¿ƒåŸºç¡€è®¾æ–½ï¼š

âœ… **ç±»å‹ä¿ç•™**ï¼šåœ¨è¿è¡Œæ—¶ä¿ç•™ TypeScript ç±»å‹ä¿¡æ¯  
âœ… **è£…é¥°å™¨æ”¯æŒ**ï¼šä¸ºè£…é¥°å™¨æä¾›æ•°æ®å­˜å‚¨èƒ½åŠ›  
âœ… **è‡ªåŠ¨æ³¨å…¥**ï¼šå®ç°è‡ªåŠ¨ä¾èµ–å‘ç°å’Œæ³¨å…¥  
âœ… **å¼€å‘ä½“éªŒ**ï¼šæä¾›ç±»ä¼¼ Laravel çš„ä¼˜é›…è¯­æ³•  
âœ… **ç”Ÿäº§å°±ç»ª**ï¼šè¢«å¹¿æ³›ä½¿ç”¨ï¼Œç¨³å®šå¯é   

ç†è§£äº† `reflect-metadata`ï¼Œä½ å°±ç†è§£äº†ç°ä»£ TypeScript æ¡†æ¶çš„"é­”æ³•"åŸç†ï¼ 
