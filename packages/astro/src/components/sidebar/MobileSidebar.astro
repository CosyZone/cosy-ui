---
/**
 * MobileSidebar组件
 *
 * 移动端侧边栏弹出层组件
 *
 * @example
 * ```astro
 * ---
 * import MobileSidebar from './MobileSidebar.astro';
 *
 * const sidebarItems = [
 *   { title: "入门", items: [
 *     { href: "/docs/getting-started", text: "快速开始" },
 *     { href: "/docs/installation", text: "安装" }
 *   ]}
 * ];
 * ---
 *
 * <MobileSidebar sidebarItems={sidebarItems} />
 * ```
 */

import "@coffic/cosy-ui-base/style";
import { SidebarNav, Modal } from "../../../index.ts";
import type { ISidebarProps } from "../../../index.ts";

export interface Props extends ISidebarProps {
	/**
	 * 是否开启调试模式，显示边框
	 * @default false
	 */
	debug?: boolean;
}

const { sidebarItems, debug = false } = Astro.props;

// 自动获取当前路径
const currentPath = Astro.url.pathname;

let title = "";
let titleHref = "";
if (sidebarItems.length > 0) {
	const sidebarMainItem = sidebarItems[0];
	title = sidebarMainItem.text;
	titleHref = sidebarMainItem.href;
}
---

{/* 移动端侧边栏弹出层 */}
<Modal
    id="mobile-sidebar"
    title={title}
    titleHref={titleHref}
    class="cosy:mx-4 cosy:lg:w-80 cosy:w-[calc(100vw-2rem)] cosy:max-w-full">
    <div
        class="cosy:h-[calc(100vh-8rem)] cosy:overflow-y-auto"
        data-mobile-sidebar-content>
        <SidebarNav
            sidebarItems={sidebarItems}
            currentPath={currentPath}
            debug={debug}
            showHeading={false}
        />
    </div>
</Modal>

<script>
    import { saveScrollPosition, restoreScrollPosition } from './utils.ts';

    // 处理移动端侧边栏滚动位置保存和恢复
    document.addEventListener('astro:before-preparation', () => {
        // 保存移动端滚动位置
        const mobileContent = document.querySelector(
            '[data-mobile-sidebar-content]'
        );
        if (mobileContent) {
            saveScrollPosition(mobileContent, 'mobileSidebarScrollPosition');
        }
    });

    document.addEventListener('astro:page-load', () => {
        // 恢复移动端滚动位置
        const mobileContent = document.querySelector(
            '[data-mobile-sidebar-content]'
        );
        if (mobileContent) {
            restoreScrollPosition(mobileContent, 'mobileSidebarScrollPosition');
        }
    });
</script>
